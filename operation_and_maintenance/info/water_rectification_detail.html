<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<link href="../../asset/css/mui.min.css" rel="stylesheet" /> 
		<link href="../../asset/css/iconfont.css" rel="stylesheet" />
		<link href="../../asset/css/mui.picker.min.css" rel="stylesheet" />
		<link href="../../asset/css/mui.poppicker.css" rel="stylesheet" />
		<link href="../../asset/css/style.css" rel="stylesheet" />
		<style>
			#list-option .mui-table-view-cell button {
				position: relative;
				right: inherit;
				-webkit-transform: inherit;
				transform: inherit;
			}
			
			.mui-table-view span.mui-pull-right {
				color: #999;
			}
			
			.img-selected,.img-selected1 {
				width: 80px;
				height: 80px;
				margin-top: 10px;
			}
			
			#popover {
				min-width: 282px;
				height: 300px;
				top: 50% !important;
				margin-top: -150px;
				left: 50% !important;
				margin-left: -141px;
			}
			
			@media (min-width: 400px) {
				#reject_popover,#popover {
					width: 80%;
					margin-left: -40%;
				}
			}
			.header_btn{
				display: none;;
			}
			#reject_popover {
				min-width: 282px;
				position: absolute;
				z-index: 999;
				display: none;
				width: 280px;
				-webkit-transition: opacity .3s;
				transition: opacity .3s;
				-webkit-transition-property: opacity;
				transition-property: opacity;
				-webkit-transform: none;
				transform: none;

				border-radius: 7px;
				background-color: #f7f7f7;
				-webkit-box-shadow: 0 0 15px rgba(0,0,0,.1);
				box-shadow: 0 0 15px rgba(0,0,0,.1);
				top: 50% !important;
				margin-top: -150px;
				left: 50% !important;
				margin-left: -141px;
			}
			
		 
		</style>
	</head>

	<body onload="app.route()">
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			
			<a class="mui-btn mui-btn-link mui-pull-right header_btn" id="confirm_btn">确认</a>
			<a class="mui-btn mui-btn-link mui-pull-right header_btn" id="finished">完成</a>
			<a class="mui-btn mui-btn-link mui-pull-right header_btn" id="reject_btn">驳回</a>
			<a class="mui-btn mui-btn-link mui-pull-right header_btn" id="start_btn">开始整改</a>
			<a class="mui-btn mui-btn-link mui-pull-right header_btn" id="zhenggai">整改</a>
			
			<!--<a class="mui-btn mui-btn-link mui-pull-right header_btn" id="reject">驳回</a>-->
			
			<a class="mui-btn mui-btn-link mui-pull-right header_btn" id="review">复核</a>
			<a class="mui-btn mui-btn-link mui-pull-right header_btn" id="deal_with">处理</a>
			<a class="mui-btn mui-btn-link mui-pull-right header_btn" id="cancel">撤销</a>
			<a class="mui-btn mui-btn-link mui-pull-right header_btn" id="feedback">反馈</a>
			<a class="mui-btn mui-btn-link mui-pull-right header_btn" id="doing_feedback">反馈</a>
			<h1 class="mui-title">水利整改单</h1>
		</header>
		<div class="mui-content">
			<ul id="list-option" class="mui-table-view">
				<li class="mui-table-view-cell">
					<!--<i class="iconfont icon-dituleiwanggequ"></i>-->问题状态
					<span id="wrd_state" style="max-width: 100%;color: red;" class="mui-pull-right mui-ellipsis"></span>
				</li>
				<li class="mui-table-view-cell">
					<!--<i class="iconfont icon-dituleiwanggequ"></i>-->问题编号
					<span id="wrd_no" style="max-width: 100%;" class="mui-pull-right mui-ellipsis"></span>
				</li>

				<li class="mui-table-view-cell">
					<!--<i class="iconfont icon-dituleiwanggequ"></i>-->水利设施
					<span id="wrd_facility" style="max-width: 100%;" class="mui-pull-right mui-ellipsis"></span>
				</li>
				<li class="mui-table-view-cell mui-hidden">
					<!--<i class="iconfont icon-dituleiwanggequ"></i>-->所在区划
					<span id="wrd_area" style="max-width: 100%;" class="mui-pull-right mui-ellipsis"><!--青松大控制/华新镇/火星村--></span>
				</li>
				<li class="mui-table-view-cell">
					<!--<i class="iconfont icon-date1"></i>-->报告时间
					<span id="wrd_date" style="max-width: 100%;" class="mui-pull-right mui-ellipsis"></span>
				</li>
				<li class="mui-table-view-cell">
					<!--<i class="iconfont icon-date1"></i>-->报告人
					<span id="wrd_reporter_name" style="max-width: 100%;" class="mui-pull-right mui-ellipsis"></span>
				</li>
				<li class="mui-table-view-cell">
					<!--<i class="iconfont icon-date1"></i>-->联系方式
					<span id="wrd_reporter_mobile" style="max-width: 100%;" class="mui-pull-right mui-ellipsis"></span>
				</li>
				<li class="mui-table-view-cell">
					<!--<i class="iconfont icon-list4f"></i>-->问题点
					<span id="wrd_problem_point" style="max-width: 100%;" class="mui-pull-right mui-ellipsis"></span>
				</li>
				<li class="mui-table-view-cell">
					<!--<i class="iconfont icon-list4f"></i>-->问题设备
					<span id="wrd_problem_device" style="max-width: 100%;" class="mui-pull-right mui-ellipsis"></span>
				</li>
				<li class="mui-table-view-cell mui-hidden">
					<!--<i class="iconfont icon-wenhaoxiao"></i>-->问题内容
					<span id="wrd_problem_content" style="max-width: 100%;" class="mui-pull-right mui-ellipsis"></span>
				</li>
				
				<li class="mui-table-view-cell">
					<!--<i class="iconfont icon-list4f"></i>-->问题类型
					<span id="wrd_problem_type" style="max-width: 100%;" class="mui-pull-right mui-ellipsis"></span>
				</li>
				<li class="mui-table-view-cell">
					<!--<i class="iconfont icon-wenhaoxiao"></i>-->问题项目
					<span id="wrd_problem_item" style="max-width: 100%;" class="mui-pull-right mui-ellipsis"></span>
				</li>
				
				<li class="mui-table-view-cell">
					检查情况说明<br><br>
					<p id="detail"></p>

				</li>
				<li class="mui-table-view-cell">
					检查问题照片

					<div id="detail_img_list">

						<!--<img src="images/evid1.png" class="img-selected1">
						<img src="images/evid1.png" class="img-selected1">
						<img src="images/evid1.png" class="img-selected1">-->

					</div>
				</li>
				<li class="mui-table-view-cell" id="wrd_money_warp" style="display: none;">
					<!--<i class="iconfont icon-list4f"></i>-->申请资金
					<span id="wrd_money" style="max-width: 100%;color: red;" class="mui-pull-right mui-ellipsis"></span>
				</li>
				<li class="mui-table-view-cell" id="complete_time_warp"  style="display: none;">
					<!--<i class="iconfont icon-list4f"></i>-->预计完成时间
					<span id="wrd_need_days" style="max-width: 100%;color: red;" class="mui-pull-right mui-ellipsis"></span>
				</li>
				<li class="mui-table-view-cell" style="display: none;">
					<i class="iconfont icon-zijin"></i> 所需资金
					<span class="mui-pull-right">(元)</span>
					<input type="number" class="mui-pull-right" style="margin-right:5px;width: 30vw;height: 24px;" />
				</li>
				<li class="mui-table-view-cell" id="zg_detail_warp" style="display: none;">
					整改中说明：<br><br>
					<p id="zg_detail"></p>
				</li>
				
				<li class="mui-table-view-cell" id="zg_img_list_warp" style="display: none;">
					整改中照片
					<div id="zg_img_list">

						<!--<img src="images/evid1.png" class="img-selected1">
                <img src="images/evid1.png" class="img-selected1">
                <img src="images/evid1.png" class="img-selected1">
                -->
					</div>
				</li>
				
				<li class="mui-table-view-cell reject_warp"  style="display: none;">
					<!--<i class="iconfont icon-date1"></i>-->整改处理人
					<span id="user_name" style="max-width: 100%;" class="mui-pull-right mui-ellipsis"></span>
				</li>
				<li class="mui-table-view-cell reject_warp"  style="display: none;">
					<!--<i class="iconfont icon-date1"></i>-->联系方式
					<span id="user_mobile" style="max-width: 100%;" class="mui-pull-right mui-ellipsis"></span>
				</li>
				<li class="mui-table-view-cell reject_warp"  style="display: none;">
					<!--<i class="iconfont icon-date1"></i>-->整改报告时间
					<span id="time_save" style="max-width: 100%;" class="mui-pull-right mui-ellipsis"></span>
				</li>

				<li class="mui-table-view-cell reject_warp"  style="display: none;">
					整改情况说明：<br><br>
					<p id="reject_detail"></p>
				</li>
				<li class="mui-table-view-cell reject_warp" id="memo_warp"  style="display: none;">
					备注：<br><br>
					<p id="reject_memo"></p>
				</li>
				<li class="mui-table-view-cell reject_warp"  style="display: none;">
					整改完成照片
					<div id="img_list111">

						<!--<img src="images/evid1.png" class="img-selected1">
                <img src="images/evid1.png" class="img-selected1">
                <img src="images/evid1.png" class="img-selected1">
                -->
					</div>
				</li>
				
				
				<br>
				<br>
				<br>
				<br>
			</ul>

		</div>
		<div id="deal_with_picture" class="mui-popover mui-popover-action mui-popover-bottom">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a onclick="internal_rectification()">内部整改（自主整改即可解决时）</a>
				</li>
				<li class="mui-table-view-cell">
					<a onclick="report_btn()">汇报（无法内部解决、需上报时）</a>
				</li>
				<li class="mui-table-view-cell">
					<a onclick="cancel()">撤销（无需整改时）</a>
				</li>
			</ul>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a href="#deal_with_picture"><b>取消</b></a>
				</li>
			</ul>
		</div>
		<div id="popover" class="mui-popover">

			<div class="mui-content-padded">
				<h4 id="popover_title" style="margin-top: 20px;">汇报</h4>
				<form class="mui-input-group" style="margin-top: 30px;padding: 5px;">

					<div id="popover_little_title">请填写申请资金额度和工期</div>

					<div style="    height: 40px;margin-top: 5px;">
						<label>资金额度(元)</label>
						<input type="number" style="       height: 30px; border: 1px solid #ccc;width: 50%;" id="money" placeholder="请输入">

					</div>
					<div style="    height: 40px;margin-top: 5px;">
						<label>完成日期</label>
						<span style="height: 30px;border: 1px solid #ccc;width: 50%;padding: 5px 15px;margin-left: 29px;color: #767676;" id="need_day" >请选择</span>
					</div>

				</form>
				<div id="add_div" class="operate " style="    text-align: right;">
					<button type="button" class="mui-btn mui-btn-blue" id="confirm_cacle">否</button>
					<button type="button" class="mui-btn mui-btn-blue" id="confirm_ok">是</button>
				</div>

			</div>
		</div>
		<div id="reject_popover" >
			<div class="mui-content-padded">
				<h4 id="title" style="margin-top: 20px;">确认驳回吗？</h4>
				<form class="mui-input-group" style="margin-top: 30px;padding: 5px;">

					<div class="mui-table-view-cell">
					<p>整改情况说明：</p><br>
					<textarea id="textarea_info" style="border: 1px solid;" rows="2" placeholder="请输入描述信息"></textarea>
				</div>
				<div class="mui-table-view-cell">
					<p>整改完成照片(长按删除)
						<a id="add_img_btn" class="mui-btn mui-btn-primary mui-btn-outlined mui-pull-right">
                    <i class="iconfont icon-add"></i>
                </a>
					</p>
					<br>
					<div id="img_list">
						<!--
                <img src="images/evid1.png" class="img-selected">
                <img src="images/evid1.png" class="img-selected">
                <img src="images/evid1.png" class="img-selected">
                -->
					</div>
				</div>
				</form>
				<div id="add_div" class="operate " style="    text-align: right;">
					<button type="button" class="mui-btn mui-btn-blue" id="reject_confirm_cacle">否</button>
					<button type="button" class="mui-btn mui-btn-blue" id="reject_confirm_ok">是</button>
				</div>
			</div>
		</div>
		<div id="picture" class="mui-popover mui-popover-action mui-popover-bottom">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a onclick="getImage()">拍照</a>
				</li>
				<!--<li class="mui-table-view-cell">
					<a onclick="galleryImgsMaximum()">选取现有的</a>
				</li>-->
			</ul>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a href="#picture"><b>取消</b></a>
				</li>
			</ul>
		</div>

		<div id="img_action_list" class="mui-popover mui-popover-action mui-popover-bottom">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a onclick="del_img()">删除</a>
				</li>
			</ul>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a href="#img_action_list"><b>取消</b></a>
				</li>
			</ul>
		</div>
	</body>
	<script src="../../asset/js/jquery-3.3.1.min.js"></script>
	<script src="../../asset/js/mui.min.js"></script>
	<script src="../../asset/js/mui.picker.min.js"></script>
	<script src="../../asset/js/mui.poppicker.js"></script>
	<script src="../../asset/js/app.js"></script>
	<script src="../../asset/js/mui.zoom.js"></script>
	<script src="../../asset/js/mui.previewimage.js"></script>
	<script type="text/javascript" charset="utf-8">
		var problem_id = app.getUrlParam('problem_id');
		var inspectionType = app.getUrlParam('inspectionType');
		console.log(inspectionType)
		if(inspectionType==8502){
			$(".mui-title").html("维护整改单")
		}
		var is_inner ;
		var rectificationSerial;
		var level1_name;
		var p_money;
		var need_day = document.getElementById('need_day');
		console.log(problem_id)
		var wrd_state = "待站长处理"
		mui.init({
				gestureConfig: {
					longtap: true
				}
			});
		mui.previewImage();
		
		need_day.addEventListener('tap', function() {　　
			document.activeElement.blur();
			var dtpicker = new mui.DtPicker({
				type: "date", //设置日历初始视图模式    
			})
			dtpicker.show(function(items) {
				need_day.innerHTML = items.value;
			})
		})

		mui.plusReady(function() {
			initCtrls()
		})
		function initCtrls(){
			var show_waiting = plus.nativeUI.showWaiting();
			app.ajax(app.url("query/problem_detail"), {
				problem_id: problem_id
			}, function(ret) {
				show_waiting.close()
				console.log(JSON.stringify(ret))
				var data = ret.data
				if(ret.code==0){
					$(".header_btn").hide()
					wrd_state = data["stage"]
					$("#wrd_state").html(wrd_state) 
					
					$("#wrd_no").html(data["problem_no"]) 
					rectificationSerial = data["problem_no"]
					$("#wrd_facility").html(data['facility_name']) 
					level1_name = data['facility_name']
//					$("#wrd_area").html(data.problem_no) 
					$("#wrd_date").html(data["time_save"]) 
					$("#wrd_reporter_name").html(data["user_name"]) 
					
					$("#wrd_reporter_mobile").html(data["user_mobile"]) 
					$("#wrd_problem_point").html(data["check_point"])
					
					
					
					if(data["problemDeviceName"]){
						$("#wrd_problem_device").html(data["problemDeviceName"]) 
					}else{
						$("#wrd_problem_device").parent().hide()
					}
					if(data["problemName"]){
						$("#wrd_problem_type").html(data["problemName"])
					}else{
						$("#wrd_problem_type").parent().hide()
					}
					if(data["subProblemName"]){
						$("#wrd_problem_item").html(data["subProblemName"])
					}else{
						$("#wrd_problem_item").parent().hide()
					}

					// $("#wrd_problem_content").html(data["check_sub_item"]) 
					$("#wrd_money").html(data["money"]) 
					if(data["complete_time"])
					$("#wrd_need_days").html(data["complete_time"].split(" ")[0]) 
					p_money = data["money"]
					$("#detail").html(data["memo"])
					var html = ""
					for (var i = 0; i < data["images"].length; i++) {
						
						html += '<img src="'+app.prefix(data["images"][i]["url_img_thumb"])+'"   data-preview-src="'+app.prefix(data["images"][i]["url_img"]) + '" data-preview-group="1"   class="img-selected1">'
						
					}
					if(data["commitInfo"]) {
						$("#zg_detail").html(data["commitInfo"]["detail"])
						 
						var zg_html = ""
						for(var i = 0; i < data["commitInfo"]["images"].length; i++) {
							zg_html += '<img src="'+app.prefix(data["commitInfo"]["images"][i]["url_img_thumb"]) + '" data-preview-src="'+app.prefix(data["commitInfo"]["images"][i]["url_img"])+ '" data-preview-group="1"  class="img-selected1" >'
							console.log(app.prefix(data["commitInfo"]["images"][i]["url_img_thumb"]))
						}
						
						$("#zg_img_list").html(zg_html)
						$("#zg_detail_warp").show()
						$("#zg_img_list_warp").show()
					}
					if(data["rectfInfo"]) {
						$(".reject_warp").show()
						$("#user_name").html(data["rectfInfo"]["username"])
						$("#time_save").html(data["rectfInfo"]["time_save"])
						$("#reject_detail").html(data["rectfInfo"]["detail"])
						if(!data["rectfInfo"]["memo"]) {
							$("#memo_warp").hide()
						} else {
							$("#reject_memo").html(data["rectfInfo"]["memo"])
						}
						var reject_html = ""
						for(var i = 0; i < data["rectfInfo"]["images"].length; i++) {
							reject_html += '<img src="' +app.prefix(data["rectfInfo"]["images"][i]["url_img_thumb"]) + '"  data-preview-src="'+app.prefix(data["rectfInfo"]["images"][i]["url_img"]) + '" data-preview-group="1"   class="img-selected1">'
						}
						$("#img_list111").html(reject_html)
					}
					
					$("#detail_img_list").html(html)
					if(wrd_state=="待站长处理"){
						$("#cancel").show()
						$('#deal_with').show()
					}
					else if(wrd_state=="内部整改中"){
						is_inner = "yes";
						$('#feedback').show()
					}
					else if(wrd_state=="内部整改提交"){
						is_inner = "yes";
						$('#finished').show()
						$('#reject_btn').show()
					}
					else if(wrd_state=="待监理复核"){
						$('#review').show()
						$('#cancel').show()
						$('#wrd_money_warp').show()	
						$('#complete_time_warp').show()	
					}
					else if(wrd_state=="待整改"){
						
						if(app.isJl() || app.isGly() || app.isXc()){
							$('#zhenggai').hide()
						}else{
							$('#zhenggai').show()
						}
		// 				$('#cancel').show()
		// 				$('#wrd_money_warp').show()	
		// 				$('#complete_time_warp').show()	
					}
					else if(wrd_state=="整改下发"){
						$('#start_btn').show()
						$('#wrd_money_warp').show()	
						$('#complete_time_warp').show()	
					}
					else if(wrd_state=="整改中"){
						if(app.isZz() || app.isAdmin() || app.isYw()){
							$('#doing_feedback').show()
						}else{
							$('#doing_feedback').hide()
						}
		// 				$('#wrd_money_warp').show()	
		// 				$('#complete_time_warp').show()	
					}
					else if(wrd_state=="提交整改"){
						$('#confirm_btn').show()
						$('#reject_btn').show()
						$('#wrd_money_warp').show()	
						$('#complete_time_warp').show()	
					}
					else if(wrd_state=="问题确认"){
						is_inner = "no";
						$('#finished').show()
						$('#reject_btn').show()
						$('#wrd_money_warp').show()	
						$('#complete_time_warp').show()	
					}
				}else{
					mui.toast(ret.desc)
				}
			})
			//			mui("#popover").popover("toggle");
		addEventLongTap()
		}
//		$("#reject").click(function() {
//			app.open("./water_rectification_reject.html?problem_id=" + problem_id+"&is_inner="+is_inner)
//		})
		$("#deal_with").click(function() {
			mui('#deal_with_picture').popover('toggle');
		})
		var type = ""
		$("#zhenggai").click(function() {
			mui.confirm('确认整改此问题吗？', '整改', ['否', '是'], function(e) {
				console.log(e.index)
				if(e.index == 1) {
					app.open("water_rectification_gaozhi.html?rectificationSerial=" + encodeURIComponent(rectificationSerial) + "&level1_name="+level1_name+"&inspectionType="+inspectionType)
				} else {
		
				}
			})

// 			type = "zhenggai"
// 			$("#need_day").html("请选择")
// 			mui("#popover").popover("toggle");
// 			
// 			
// 			$("#popover_title").html("整改")
//			$("#popover_little_title").html("请确定给予的资金额度和工期。")
		})
		$("#cancel").click(function() {
			cancel()
		})
		$("#finished").click(function() {
			complete()
		})
		$("#confirm_ok").click(function() {
			if(type=="report"){
				console.log("report")
				report()
			}else if(type=="zhenggai"){
				console.log("init_rectification")
				init_rectification()
			}
			
		})
		$("#review").click(function() {
			review()
		})
		$("#confirm_cacle").click(function() {
			mui("#popover").popover("toggle");
		})
		$("#feedback").click(function() {
			app.open("./water_rectification_feedback.html?rectificationSerial=" + encodeURIComponent(rectificationSerial) + "&level1_name="+level1_name+"&inspectionType="+inspectionType)
		})
		$("#doing_feedback").click(function() {
//			app.open("./water_rectification_doing_detail.html?problem_id=" + problem_id)
			app.open("./water_rectification_feedback.html?rectificationSerial=" + encodeURIComponent(rectificationSerial) + "&level1_name="+level1_name+"&is_inner=no&inspectionType="+inspectionType)
		})
		$("#confirm_btn").click(function() {
			confirm()
		})
//		//驳回
//		$("#reject_btn").click(function() {
//			app.open("./water_rectification_reject_detail.html?problem_id=" + problem_id)
//		})
		$("#start_btn").click(function() {
			app.open("./water_rectification_gaozhi.html?rectificationSerial=" + encodeURIComponent(rectificationSerial) + "&level1_name="+level1_name+"&p_money="+p_money)
		})
		//内部整改
		function internal_rectification() {
			console.log("rectificationSerial:"+rectificationSerial)
			mui.confirm('确认该问题需要整改吗？', '内部整改', ['否', '是'], function(e) {
				console.log(e.index)
				if(e.index == 1) {
					app.ajax(app.url1('inspect/start/rectification/inner'), {
						"rectificationSerial": rectificationSerial
					}, function(ret) {
						if(ret.code==200){
							console.log(JSON.stringify(ret))
							var parentViewer = mui.currentWebview.opener();
							mui.fire(parentViewer, 'wga_refresh');
							mui.toast(ret.msg)
							app.ajaxBack()
						}else{
							mui.toast(ret.msg)
						}
					})
				} else {

				}
			})

		}
 
		//取消整改
		function cancel() {
			mui.confirm('撤销该报告，确定吗？', '撤销', ['否', '是'], function(e) {
				console.log(e.index)
				if(e.index == 1) {
					app.ajaxJson(app.url1('inspect/cancel/rectification'), JSON.stringify({
						"rectificationSerial": rectificationSerial,
						"content": "这个问题不需要整改"
					}), function(ret) {
						if(ret.code==200){
						console.log(JSON.stringify(ret))
						mui.toast(ret.msg)
						var parentViewer = mui.currentWebview.opener();
						mui.fire(parentViewer, 'wga_refresh');
						app.ajaxBack()
						}else{
							mui.toast(ret.msg)
						}
					})
				} else {

				}
			})
		}
		//完成整改
		function complete() {
			mui.confirm('确定完成该问题的整改流程吗？', '完成整改', ['否', '是'], function(e) {
				console.log(e.index)
				if(e.index == 1) {
					app.ajaxJson(app.url1('inspect/complete/rectification'), JSON.stringify({
						"rectificationSerial": rectificationSerial,
						"content": ""
					}), function(ret) {
						if(ret.code==200){
						console.log(JSON.stringify(ret))
						mui.toast(ret.msg)
						var parentViewer = mui.currentWebview.opener();
						mui.fire(parentViewer, 'wga_refresh');
						app.ajaxBack()
						}else{
							mui.toast(ret.msg)
						}
					})
				} else {

				}
			})
		 
		}
		//确认整改
		function confirm() {
			mui.confirm('确认该问题经整改后已恢复吗？', '确认', ['否', '是'], function(e) {
				console.log(e.index)
				if(e.index == 1) {
					app.ajaxJson(app.url1('inspect/confirm/rectification'), JSON.stringify({
						"rectificationSerial": rectificationSerial,
						"content": "",
					}), function(ret) {
						if(ret.code==200){
						console.log(JSON.stringify(ret))
						mui.toast(ret.msg)
						var parentViewer = mui.currentWebview.opener();
						mui.fire(parentViewer, 'wga_refresh');
						app.ajaxBack()
						}else{
							mui.toast(ret.msg)
						}
					})
				} else {

				}
			})
		}
		//下发整改问题
		function init_rectification() {
			
//			var curDate = new Date();  
//			
//  			var startDate=new Date(curDate.setDate(curDate.getDate()+parseInt($("#need_day").val())));
//			console.log('startDate.format("yyyy-MM-dd hh:mm:ss"):'+startDate.format("yyyy-MM-dd hh:mm:ss"))
			var startDate=$("#need_day").html()
			var finish_time = ""
			if(startDate=="" || startDate=="请选择"){
				finish_time = ""
			}else{
				finish_time = startDate+" 00:00:00"
			}
			app.ajaxJson(app.url1('inspect/init/rectification'), JSON.stringify({
				"rectificationSerial": rectificationSerial, // 必选
				"content": "下发整改",
				"remark": "",
				"expenseMoney": $("#money").val(), // 允诺的钱， 可选
				"requestCompleteDate": finish_time// 要求完成时间，可选
			}), function(ret) {
				if(ret.code==200){
				mui.toast(ret.msg)
				var parentViewer = mui.currentWebview.opener();
				mui.fire(parentViewer, 'wga_refresh');
				app.ajaxBack()
				}else{
							mui.toast(ret.msg)
						}
			})
		}
		//监理复核问题
		function review() {
			
			mui.confirm('确认该问题存在吗？', '复核', ['否', '是'], function(e) {
				console.log(e.index)
				if(e.index == 1) {
					app.ajaxJson(app.url1('inspect/review/rectification'), JSON.stringify({
						"rectificationSerial": rectificationSerial,
						"content": "",
						"remark": ""
					}), function(ret) {
						if(ret.code==200){
						console.log(JSON.stringify(ret))
						mui.toast(ret.msg)
						var parentViewer = mui.currentWebview.opener();
						mui.fire(parentViewer, 'wga_refresh');
						app.ajaxBack()
						}else{
							mui.toast(ret.msg)
						}
					})
				} else {

				}
			})
		 
		
			 
		}
		function report_btn() {
		 
			type = "report"
			$("#popover_title").html("汇报")
			$("#popover_little_title").html("请填写申请资金额度和工期")
			$("#need_day").html("请选择")
			mui("#popover").popover("toggle");
		}
		//站长汇报问题
		function report() {
			
//			if($("#need_day").val()){
//				var curDate = new Date();  
////  				var startDate=new Date(curDate.setDate(curDate.getDate()+parseInt($("#need_day").val())));
//  				
//			}
			var startDate=$("#need_day").html()
			var finish_time = ""
			if(startDate=="" || startDate=="请选择"){
				finish_time = ""
			}else{
				finish_time = startDate+" 00:00:00"
			}
			
			
			console.log('finish_time'+finish_time)
			app.ajaxJson(app.url1('inspect/report/rectification'), JSON.stringify({
				"rectificationSerial": rectificationSerial,
				"expenseMoney": $("#money").val(), // 必选
				"requestCompleteDate": finish_time, // 完成时间，必选
				"content": "",
				"remark": ""
			}), function(ret) {
				if(ret.code==200){
					console.log(JSON.stringify(ret))
					mui.toast(ret.msg)
					var parentViewer = mui.currentWebview.opener();
					mui.fire(parentViewer, 'wga_refresh');
					app.ajaxBack()
				}else{
					mui.toast(ret.msg)
				}
				
			})
		}

		mui.plusReady(function() {
//			app.previewImage(".mui-content")
			
		});
		
		window.addEventListener('wga_refresh_refresh', function(event) {
 
			initCtrls();
			var parentViewer = mui.currentWebview.opener();
			mui.fire(parentViewer, 'wga_refresh');
		});
		
		$("#add_img_btn").click(function() {
			add_img()
		})
		function addImg(strSrc) {
			console.log(strSrc);

			plus.io.resolveLocalFileSystemURL(strSrc, function(entry) {
				//			console.log(entry);
				entry.getMetadata(function(metadata) {
					if(metadata.size > 1024 * 1024) // 1M
					{
						// comparess image
						var nPtPos = strSrc.lastIndexOf('.');
						var strDst = '';
						if(nPtPos > 0) {
							strDst = strSrc.substr(0, nPtPos) + '_s50' + strSrc.substr(nPtPos);
						} else {
							strDst = strSrc + '_s50';
						}
						//					console.log('dist ' + strDst);

						// compress image
						var wUI = plus.nativeUI.showWaiting('压缩中...');
						plus.zip.compressImage({
								src: strSrc,
								dst: strDst,
								overwrite: true,
								width: '100%',
								height: '100%',
								quality: 80
							},
							function(e) {
								wUI.close();

								// add image
								//							console.log('compress size: ' + e.size);

								//							console.log(e.target);
								var newImg = document.createElement('img');
								newImg.src = e.target;
								newImg.classList.add("img-selected");

								newImg.addEventListener('longtap', function() {
									currentImgItem = this;
									mui('#img_action_list').popover('toggle');
								})

								img_list.appendChild(newImg);
							},
							function(e) {
								wUI.close();
								mui.toast('压缩文件失败：' + e.message);
							})
					} else {
						var newImg = document.createElement('img');
						newImg.src = strSrc;
						newImg.classList.add("img-selected");

						newImg.addEventListener('longtap', function() {
							currentImgItem = this;
							mui('#img_action_list').popover('toggle');
						})

						img_list.appendChild(newImg);
					}
				}, function(err) {
					mui.toast('打开文件错误');
				})
			});
		}

		var upload;
		$("#reject_btn,#reject_confirm_cacle").click(function() {
			
		 	$("#reject_popover").toggle()
		})
		$("#reject_confirm_ok").click(function() {
		 
			var arrImgs = new Array();
			$(".img-selected").each(function(key, value) {
				arrImgs.push($(value).attr('src'))
			})
			upload = plus.nativeUI.showWaiting('上传中...');
			if(fg) {
				getImgToBase64(arrImgs)

				fg = false;
			}
		})
		 
		var count = 0;
		var file_data_arr = [];
		var fg = true;

		function uploadImg() {
			console.log("uploadImg")
			var xhr = new XMLHttpRequest();
			xhr.timeout = 120000;
			xhr.ontimeout = function(e) { 
				mui.toast('请求超时，请再网络状态良好的地方重试');
				upload.close()
			};
			var formData = new FormData();

			for(var i = 0; i < file_data_arr.length; i++) {

				formData.append('files', file_data_arr[i]);

			}
			console.log(rectificationSerial)
			formData.append("rectificationSerial", rectificationSerial);
			formData.append("content", $("#textarea_info").val());
			formData.append("remark", "");
			formData.append("reportTime", new Date().format("yyyy-MM-dd hh:mm:ss"));

			xhr.onreadystatechange = function(e) {

				if(xhr.readyState == 4) {
					console.log(xhr.responseText)
					file_data_arr = [];
					count = 0;
					fg = true;
					if(xhr.status == 200) {
						var ret = JSON.parse(xhr.responseText);
						if(ret.code == 200) {
							mui.toast('上传成功');

							console.log(ret.data)

							
							var parentViewer = mui.currentWebview.opener();
							mui.fire(parentViewer, 'wga_refresh');

							app.ajaxBack();
						} else {
							mui.toast('保存失败，请重新保存');
						}

					} else {

						mui.toast('保存失败，请重新保存');

					}
					upload.close()
					return;
				}
			}
			if(is_inner=="yes"){
				xhr.open('POST', app.url1('inspect/reject/rectification/inner'), true);
			}else{
				xhr.open('POST', app.url1('inspect/reject/rectification'), true);
			}
	
			xhr.send(formData);
		}

		//将图片转换为Base64
		function getImgToBase64(arr) {
//			console.log("getImgToBase64")
			var canvas = document.createElement('canvas'),
				ctx = canvas.getContext('2d'),
				img = new Image;
			img.crossOrigin = 'Anonymous';

			img.onload = function() {
				var originWidth = img.width;
		        var originHeight = img.height;
		        // 最大尺寸限制
		        var maxWidth = app.maxWidth(), maxHeight = app.maxWidth();
		        // 目标尺寸
		        var targetWidth = originWidth, targetHeight = originHeight;
		        // 图片尺寸超过1000x1000的限制
		        if (originWidth > maxWidth || originHeight > maxHeight) {
		            if (originWidth / originHeight > maxWidth / maxHeight) {
		                targetWidth = maxWidth;
		                targetHeight = Math.round(maxWidth * (originHeight / originWidth));
		            } else {
		                targetHeight = maxHeight;
		                targetWidth = Math.round(maxHeight * (originWidth / originHeight));
		            }
		        }
				
				// canvas对图片进行缩放
		        canvas.width = targetWidth;
		        canvas.height = targetHeight;
		    
		        // 清除画布
		        ctx.clearRect(0, 0, targetWidth, targetHeight);
		        // 图片压缩
		        ctx.drawImage(img, 0, 0, targetWidth, targetHeight);
			
				ctx.font = targetWidth / 20 + "px microsoft yahei";
				ctx.fillStyle = "rgba(255,128,0,1)";
				var txt = new Date().format("yyyy-MM-dd hh:mm:ss")
				var pos_x = targetWidth - ctx.measureText(txt).width
				var pos_y = targetHeight - targetWidth / 20
			 
				ctx.fillText(txt, pos_x, pos_y);
				console.log(targetWidth,targetHeight)
				var dataURL = canvas.toDataURL('image/jpeg');

				file_data_arr.push(dataURLtoFile(dataURL, 'img' + count + '.jpg'))
				//						console.log("====")
				count++;
				getImgToBase64(arr)

				canvas = null;
			};
			img.src = arr[count];
			if(file_data_arr.length == arr.length) {
				uploadImg()
			}
		}
		//将base64转换为文件
		function dataURLtoFile(dataurl, filename) {
			var arr = dataurl.split(','),
				mime = arr[0].match(/:(.*?);/)[1],

				bstr = atob(arr[1]),
				n = bstr.length,
				u8arr = new Uint8Array(n);
			//					console.log(mime)
			while(n--) {
				u8arr[n] = bstr.charCodeAt(n);
			}
			return new File([u8arr], filename, {
				type: mime
			});
		}
		function addEventLongTap() {

			var arrItems = document.querySelectorAll('.img-selected');

			[].forEach.call(arrItems, function(item) {
				item.addEventListener('longtap', function() {
					currentImgItem = this;
					mui('#img_action_list').popover('toggle');
				})
			});
		}
		function add_img() {
			if(document.querySelectorAll('.img-selected').length >= app.max_count_photos) {
				mui.toast('取证照片已至最大数量');
				return;
			}

			mui('#picture').popover('toggle');
		}

		function del_img() {
			if(currentImgItem) {
				currentImgItem.parentNode.removeChild(currentImgItem);
				currentImgItem = null;
			}

			mui('#img_action_list').popover('toggle');
		}

		function getImage() {
			var cmr = plus.camera.getCamera();
			cmr.captureImage(function(path) {
				//				console.log('get image ' + path);
				//				addImg(path);

				plus.gallery.save(path, function(event) {
					plus.io.resolveLocalFileSystemURL(path, function(entry) {
						addImg("file://" + entry.fullPath);
					}, function(e) {
						console.log('路径解析失败: ' + JSON.stringify(e));
					});
				}, function(e) {
					console.log('保存失败: ' + JSON.stringify(e));
				});
			}, function(e) {
				//			console.log(JSON.stringify(e));
			}, {
				filename: '_doc/gallery/',
				index: 1
			});

			mui('#picture').popover('toggle');
		}

		function addImg(strSrc) {
			console.log(strSrc);

			plus.io.resolveLocalFileSystemURL(strSrc, function(entry) {
				//			console.log(entry);
				entry.getMetadata(function(metadata) {
					if(metadata.size > 1024 * 1024) // 1M
					{
						// comparess image
						var nPtPos = strSrc.lastIndexOf('.');
						var strDst = '';
						if(nPtPos > 0) {
							strDst = strSrc.substr(0, nPtPos) + '_s50' + strSrc.substr(nPtPos);
						} else {
							strDst = strSrc + '_s50';
						}
						//					console.log('dist ' + strDst);

						// compress image
						var wUI = plus.nativeUI.showWaiting('压缩中...');
						plus.zip.compressImage({
								src: strSrc,
								dst: strDst,
								overwrite: true,
								width: '100%',
								height: '100%',
								quality: 80
							},
							function(e) {
								wUI.close();

								// add image
								//							console.log('compress size: ' + e.size);

								//							console.log(e.target);
								var newImg = document.createElement('img');
								newImg.src = e.target;
								newImg.classList.add("img-selected");

								newImg.addEventListener('longtap', function() {
									currentImgItem = this;
									mui('#img_action_list').popover('toggle');
								})

								img_list.appendChild(newImg);
							},
							function(e) {
								wUI.close();
								mui.toast('压缩文件失败：' + e.message);
							})
					} else {
						var newImg = document.createElement('img');
						newImg.src = strSrc;
						newImg.classList.add("img-selected");

						newImg.addEventListener('longtap', function() {
							currentImgItem = this;
							mui('#img_action_list').popover('toggle');
						})

						img_list.appendChild(newImg);
					}
				}, function(err) {
					mui.toast('打开文件错误');
				})
			});
		}

		function galleryImgsMaximum() {
			var maxValue = app.max_count_photos - document.querySelectorAll('.img-selected').length;
			if(maxValue < 0)
				maxValue = 0;

			if(maxValue == 0) {
				alert('取证图片已选至最大数量');
				mui('#picture').popover('toggle');
				return;
			}

			// 从相册中选择图片
			plus.gallery.pick(function(e) {
				for(var i in e.files) {
					addImg(e.files[i]);
				}
			}, function(e) {
				//	outSet('取消选择图片');
			}, {
				filter: 'image',
				multiple: true,
				maximum: maxValue,
				system: false,
				onmaxed: function() {
					plus.nativeUI.alert('最多只能选择' + maxValue + '张图片');
				}
			}); // 最多选择3张图片

			mui('#picture').popover('toggle');
		}
		
		
		window.addEventListener('problem_refresh', function(event) {
			var parentViewer = mui.currentWebview.opener();
			mui.fire(parentViewer, 'wga_refresh');
		});
		window.addEventListener('problem_back', function(event) {
			setTimeout(function(){
				app.ajaxBack()
			},800)
			
		});
	</script>

</html>