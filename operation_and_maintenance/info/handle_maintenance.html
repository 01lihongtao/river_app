<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<link href="../../asset/css/mui.min.css" rel="stylesheet" />
		<link href="../../asset/css/iconfont.css" rel="stylesheet" />
		<link href="../../asset/css/mui.picker.min.css" rel="stylesheet" />
		<link href="../../asset/css/mui.poppicker.css" rel="stylesheet" />
		<link href="../../asset/css/style.css" rel="stylesheet" />
		<style>
			#list-option .mui-table-view-cell button {
				position: relative;
				right: inherit;
				-webkit-transform: inherit;
				transform: inherit;
			}
			
			.mui-table-view span.mui-pull-right {
				color: #999;
			}
			
			.img-selected {
				width: 80px;
				height: 80px;
				margin-top: 10px;
			}
			textarea::-webkit-input-placeholder { /* WebKit browsers */
			  font-size: 14px;
			}
			.mui-table-view-cell.mui-active {
				background-color: #fff;
			}
			
			
		</style>
	</head>

	<body onload="app.route()">
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<!-- <span id="scan_qr"  onclick="clicked('../../barcode_scan.html',true,true)" class=" mui-btn mui-btn-link mui-pull-left   iconfont icon-im_erweimasaomiao" style="font-weight:bold;font-size:18px;padding: 0 10px;margin-left:20px;"></span> -->

			<a class="mui-btn mui-btn-link mui-pull-right btn_cancel">取消</a>
			<a class="mui-btn mui-btn-link mui-pull-right btn_submit">上传</a>
			<a class="mui-btn mui-btn-link mui-pull-right save_btn">保存</a>
			<h1 class="mui-title">日常养护登记2</h1>
		</header>
		<div class="mui-content">
			<ul id="list-option" class="mui-table-view">
				<li class="mui-table-view-cell">
					<i class="iconfont icon-date1"></i> 登记时间
					<span id="selectDate" style="max-width: 100%;" class="mui-pull-right mui-ellipsis">请选择..</span>
				</li>
				
				<li class="mui-table-view-cell">
					<i class="iconfont icon-dituleiwanggequ"></i> 设施名称
					<span id="select_facility" style="max-width: 100%;" class="mui-pull-right mui-ellipsis">请选择..</span>
					<input type="text" id="facility_input_name" placeholder="输入设施名称"
					 style="width: 88px;padding: 0;margin: 0;line-height: 23px;height: 25px;float: right;   
					  margin-right: 10px;font-size: 12px;" />
				</li>

				<li id="select_type" class="mui-table-view-cell">
					<i class="iconfont icon-erji-yunweibaobiao"></i> 养护内容
					<span id="select_content" style="max-width: 100%;" class="mui-pull-right mui-ellipsis">请选择..</span>
				</li>


				
				<!-- <li class="mui-table-view-cell">
					<i class="iconfont icon-detail"></i> 养护项目

					<span id="select_item" style="max-width: 100%;" class="mui-pull-right mui-ellipsis">请选择..</span>
					<input type="number" id="select_person_count" placeholder="" style="width: 44px;padding: 0;margin: 0;line-height: 23px;height: 25px;float: right;    margin-right: 10px;font-size: 12px;display: none;" />
				</li> -->
				<li class="mui-table-view-cell">
					<i class="iconfont icon-xunjiandengji"></i> 工程量
					<input id="unit_count" type="number" class="" style="margin:0 5px;width: 20vw;height: 24px;" />

					<span id="select_unit" class="mui-pull-right">请选择..</span>
					<span class="mui-pull-right" style="color: #000000;margin-right: 5px;">单位: </span>
				</li>
			

				<li class="mui-table-view-cell">
					<p><span style="color: #000000;">养护前描述：</span></p><br>
					<textarea id="textarea_before" rows="3" placeholder="请输入描述信息"></textarea>
				</li>
				<li class="mui-table-view-cell">
					<p><span style="color: #000000;">养护前照片</span> (最多
						<span class="max_photos">3</span>张) (长按删除)
						<button onclick="add_img('picture_before','img_list_before')" class="mui-btn mui-btn-primary mui-btn-outlined mui-pull-right">
							<i class="iconfont icon-add"></i>
						</button>
					</p>
					<br>
					<div id="img_list_before">
						<!--
                <img src="images/evid1.png" class="img-selected">
                <img src="images/evid1.png" class="img-selected">
                <img src="images/evid1.png" class="img-selected">
                -->
					</div>
				</li>
				<!-- 中 -->
				<li class="mui-table-view-cell">
					<p><span style="color: #000000;">养护中描述：</span></p><br>
					<textarea id="textarea_middle" rows="3" placeholder="请输入描述信息"></textarea>
				</li>
				<li class="mui-table-view-cell">
					<p><span style="color: #000000;">养护中照片</span> (最多
						<span class="max_photos">3</span>张) (长按删除)
						<button onclick="add_img('picture_middle','img_list_middle')" class="mui-btn mui-btn-primary mui-btn-outlined mui-pull-right">
							<i class="iconfont icon-add"></i>
						</button>
					</p>
					<br>
					<div id="img_list_middle">
						<!--
                <img src="images/evid1.png" class="img-selected">
                <img src="images/evid1.png" class="img-selected">
                <img src="images/evid1.png" class="img-selected">
                -->
					</div>
				</li>
				<!-- 后 -->
				<li class="mui-table-view-cell">
					<p><span style="color: #000000;">养护后描述：</span></p><br>
					<textarea id="textarea_after" rows="3" placeholder="请输入描述信息"></textarea>
				</li>
				<li class="mui-table-view-cell">
					<p><span style="color: #000000;">养护后照片</span> (最多
						<span class="max_photos">3</span>张) (长按删除)
						<button onclick="add_img('picture_after','img_list_after')" class="mui-btn mui-btn-primary mui-btn-outlined mui-pull-right">
							<i class="iconfont icon-add"></i>
						</button>
					</p>
					<br>
					<div id="img_list_after">
						<!--
                <img src="images/evid1.png" class="img-selected">
                <img src="images/evid1.png" class="img-selected">
                <img src="images/evid1.png" class="img-selected">
                -->
					</div>
				</li>


			</ul>

		</div>

		<div id="picture_before" class="mui-popover mui-popover-action mui-popover-bottom">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a onclick="getImage('picture_before','img_action_list_before','img_list_before')">拍照</a>
				</li>
				<li class="mui-table-view-cell">
					<a onclick="galleryImgsMaximum('picture_before','img_action_list_before','img_list_before')">选取现有的</a>
				</li>
			</ul>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a href="#picture_before"><b>取消</b></a>
				</li>
			</ul>
		</div>

		<div id="img_action_list_before" class="mui-popover mui-popover-action mui-popover-bottom">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a onclick="del_img('img_action_list_before','img_list_before')">删除</a>
				</li>
			</ul>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a href="#img_action_list_before"><b>取消</b></a>
				</li>
			</ul>
		</div>
		<!-- after -->
		<div id="picture_after" class="mui-popover mui-popover-action mui-popover-bottom">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a onclick="getImage('picture_after','img_action_list_after','img_list_after')">拍照</a>
				</li>
				<li class="mui-table-view-cell">
					<a onclick="galleryImgsMaximum('picture_after','img_action_list_after','img_list_after')">选取现有的</a>
				</li>
			</ul>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a href="#picture_after"><b>取消</b></a>
				</li>
			</ul>
		</div>

		<div id="img_action_list_after" class="mui-popover mui-popover-action mui-popover-bottom">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a onclick="del_img('img_action_list_after','img_list_after')">删除</a>
				</li>
			</ul>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a href="#img_action_list_after"><b>取消</b></a>
				</li>
			</ul>
		</div>
		<!-- middle -->
		<div id="picture_middle" class="mui-popover mui-popover-action mui-popover-bottom">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a onclick="getImage('picture_middle','img_action_list_middle','img_list_middle')">拍照</a>
				</li>
				<li class="mui-table-view-cell">
					<a onclick="galleryImgsMaximum('picture_middle','img_action_list_middle','img_list_middle')">选取现有的</a>
				</li>
			</ul>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a href="#picture_middle"><b>取消</b></a>
				</li>
			</ul>
		</div>

		<div id="img_action_list_middle" class="mui-popover mui-popover-action mui-popover-bottom">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a onclick="del_img('img_action_list_middle','img_list_middle')">删除</a>
				</li>
			</ul>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a href="#img_action_list_middle"><b>取消</b></a>
				</li>
			</ul>
		</div>
	</body>
	<script src="../../asset/js/jquery-3.3.1.min.js"></script>
	<script src="../../asset/js/mui.min.js"></script>
	<script src="../../asset/js/mui.picker.min.js"></script>
	<script src="../../asset/js/mui.poppicker.js"></script>
	<script src="../../asset/js/app.js"></script>
	<script type="text/javascript" src="../../asset/js/common.js"></script>
	<script type="text/javascript" charset="utf-8">
		var upload;
		var user_data = app.getUserInfo();
		var user_id = user_data.id
		var uuid = app.getUrlParam('uuid');
		var maintenaceRepairType = app.getUrlParam('maintenaceRepairType');
		maintenaceRepairType = maintenaceRepairType ? maintenaceRepairType : 8801
		console.log(maintenaceRepairType)
		var select_facility = document.getElementById('select_facility');
		var select_content = document.getElementById('select_content');
		var select_type = document.getElementById('select_type');
		// var select_item = document.getElementById('select_item');
		var select_unit = document.getElementById('select_unit');
		var unit_count = document.getElementById('unit_count');

		var name_picker = new mui.PopPicker();
		var content_picker = new mui.PopPicker();
		var type_picker = new mui.PopPicker();
		var item_picker = new mui.PopPicker();
		var unit_picker = new mui.PopPicker();
		//时间
		var save_time = ""
		var current_time = new Date().format("yyyy-MM-dd hh:mm:ss")
		//图片
		var addImage = document.getElementById('addImage');
		//用户信息
		var user_data = app.getUserInfo();
		var cp_id = user_data.company_id
		//养护类别
		var categoryName = ""
		//水利设施id
		var facility_id = ""
		var processStage = 8001; //1前//2中//3后
		var init_flag = true; //根据uuid判断
		var file1Arr = new Array(); //维修前照片数组
		var file2Arr = new Array(); //维修中照片数组
		var file3Arr = new Array(); //维修后照片数组
		var file1_data_arr = new Array();
		var file2_data_arr = new Array();
		var file3_data_arr = new Array();

		$(function() {
			$(".max_photos").html(app.max_count_photos)
				// $("#select_type").parent().show()  //暂时关闭
				$("#select_content").parent().show()
		// 	if (maintenaceRepairType == 8802) {
		// 		$(".mui-title").html("维护作业登记")
		
		// 		// $("#select_item").parent().hide()
		// 	} else {
		// 		$("#select_content").parent().hide()
		// 	}
			app.get_time(function(ret) {
				// console.log("get_time:=====>" + ret)
				current_time = selectDate.innerHTML = ret
			})
		})
		if (uuid) {
			init_flag = false
			var maintenace_report = JSON.parse(app.getSetting("maintenace_report" + user_id) || "[]");
			// console.log(app.getSetting("maintenace_report"+user_id) || "[]")
			for (var i = 0; i < maintenace_report.length; i++) {
				if (uuid == maintenace_report[i]["list_info"]["uuid"]) {
					$(".mui-content").html(maintenace_report[i]["data"]["html"])
					maintenaceRepairType = maintenace_report[i]["maintenaceRepairType"]
					$("#unit_count").val(maintenace_report[i]["list_info"]["unit_count"])
					current_time = selectDate.innerHTML = maintenace_report[i]["post_json"]["time"]
					facility_id = maintenace_report[i]["list_info"]["id"]
					$("#textarea_before").val(maintenace_report[i]["post_json"]["process"]["before"]["remark"])
					$("#textarea_middle").val(maintenace_report[i]["post_json"]["process"]["middle"]["remark"])
					$("#textarea_after").val(maintenace_report[i]["post_json"]["process"]["after"]["remark"])
				}
			}


			$(".btn_submit").show()
			$(".save_btn").show()
			$(".btn_cancel").hide()
		} else {
			//判断是不是从巡检登记 过来的
			$(".btn_submit").hide()
			$(".save_btn").show()
			$(".btn_cancel").show()
		}


		mui.ready(function() {
			$(".btn_cancel").click(function() {
				mui.confirm('确定还原初始界面吗？', '初始界', ['否', '是'], function(e) {
					// console.log(e.index)
					if (e.index == 1) {
						window.location.reload()
						//					mui.toast("还原成功")
					} else {

					}
				})
			})

			mui.init({
				gestureConfig: {
					longtap: true
				}
			});

			var timerInputName = 0;
			document.getElementById("facility_input_name").addEventListener('input', function() {
				if (timerInputName != 0) {
					clearTimeout(timerInputName);
					timerInputName = 0;
				}
				timerInputName = setTimeout(function() {
					init_facility_list();
				}, 1000);
			});

			document.getElementById("facility_input_name").addEventListener('tap', function() {
				$('#facility_input_name').focus();
			});

			document.getElementById('selectDate').addEventListener('tap', function() {
				app.pickDate(this, true);
			}, false);
			init_pickers();
			init_facility_list();
			if (maintenaceRepairType == 8802) {
				init_content()
			} else {
				init_type();
				init_item();
			}
			init_unit()
			addEventLongTap('img_action_list_before', 'img_list_before');
			addEventLongTap('img_action_list_after', 'img_list_after');
			addEventLongTap('img_action_list_middle', 'img_list_middle');


		})
		//上传
		$(".btn_submit").click(function() {
			processStage = 8001;
			if (!check_param()) {
				return false;
			}
			// upload = plus.nativeUI.showWaiting('数据上传中...');
			start_upload()
		})

		function start_upload() {
			$("#img_list_before .img-selected").each(function(key, value) {
				file1Arr.push($(value).attr('src'));
			})
			$("#img_list_middle .img-selected").each(function(key, value) {
				file2Arr.push($(value).attr('src'));
			})
			$("#img_list_after .img-selected").each(function(key, value) {
				file3Arr.push($(value).attr('src'));
			})
			
			if (fg) {
				getImgToBase64(file1Arr, file1_data_arr, file1Arr.length, 0);
				fg = false;
			}

			// var arrImgs = new Array();
			// if (processStage == 8001) {
			// 	$("#img_list_before .img-selected").each(function(key, value) {
			// 		arrImgs.push($(value).attr('src'))
			// 	})
			// 	upload = plus.nativeUI.showWaiting('维修前 数据上传中...');
			// } else if (processStage == 8002) {
			// 	$("#img_list_middle .img-selected").each(function(key, value) {
			// 		arrImgs.push($(value).attr('src'))
			// 	})
			// 	upload = plus.nativeUI.showWaiting('维修中 数据上传中...');
			// } else {
			// 	$("#img_list_after .img-selected").each(function(key, value) {
			// 		arrImgs.push($(value).attr('src'))
			// 	})
			// 	upload = plus.nativeUI.showWaiting('维修后 数据上传中...');
			// }
			// if (fg) {
			// 	getImgToBase64(arrImgs)
			// 	fg = false;
			// }
		}
		//保存
		$(".save_btn").click(function() {
			if (!check_param()) {
				return false;
			}
			var arr;
			//			app.setSetting("problem_report"+user_id, JSON.stringify([]));
			if (app.getSetting("maintenace_report" + user_id) == "") {
				arr = [];
			} else {
				arr = JSON.parse(app.getSetting("maintenace_report" + user_id) || "[]")
			}

			var var_uuid = uuid ? uuid : new Date().format("yyyyMMddhhmmssS")
			for (var i = 0; i < arr.length; i++) {
				if (arr[i]["list_info"]["uuid"] == var_uuid) {
					arr.remove(arr[i])
				}
			}
			var before_arr_imgs = new Array();
			$("#img_list_before .img-selected").each(function(key, value) {
				before_arr_imgs.push($(value).attr('src'))
			})
			var middle_arr_imgs = new Array();
			$("#img_list_middle .img-selected").each(function(key, value) {
				middle_arr_imgs.push($(value).attr('src'))
			})
			var after_arr_imgs = new Array();
			$("#img_list_after .img-selected").each(function(key, value) {
				after_arr_imgs.push($(value).attr('src'))
			})
			mapData = {
				html: $(".mui-content").html(),
			};
			var post_json_data = {
				maintenaceRepairType: maintenaceRepairType,
				facilityInfoId: $('#select_facility').attr('item_id'),
			}
			if (maintenaceRepairType == 8802) {
				post_json_data.entityInfoId = $('#select_content').attr('item_id');
			} else {
				// post_json_data.entityInfoId = $('#select_item').attr('item_id');
			}
			if ($("#unit_count").val()) {
				post_json_data.number = $("#unit_count").val();
			}
			if ($("#select_unit").attr("item_id")) {
				post_json_data.unit = $("#select_unit").attr("item_id");
			}


			post_json_data.process = {
				before: {
					processStage: 8001,
					remark: $("#textarea_before").val(),
				},
				middle: {
					processStage: 8002,
					remark: $("#textarea_middle").val()
				},
				after: {
					processStage: 8003,
					remark: $("#textarea_after").val()
				}
			}

			arr.push({
				list_info: {
					id: $('#select_facility').attr('item_id'),
					name: $.trim($('#select_facility').html()),
					uuid: var_uuid,
					time: current_time,
					save_time: current_time,
					user_name: user_data.user_name,
					unit_count: $("#unit_count").val()
				},
				post_json: post_json_data,
				data: mapData,
				before_arr_imgs: before_arr_imgs,
				middle_arr_imgs: middle_arr_imgs,
				after_arr_imgs: after_arr_imgs,
				type: "maintenace_report",
				maintenaceRepairType: maintenaceRepairType
			})

			// console.log(JSON.stringify(arr))

			app.setSetting("maintenace_report" + user_id, JSON.stringify(arr));
			var parentViewer = mui.currentWebview.opener();
			mui.fire(parentViewer, 'wga_refresh');
			mui.toast('养护登记已保存，请至"信息流转/维修养护"中查看，请手动提交服务器');
			app.ajaxBack();
		})

		function check_param() {
			if (!$('#select_facility').attr('item_id')) {
				mui.toast('设施名称不能为空');
				return false;
			}
			if (maintenaceRepairType == 8802) {
				if (!$('#select_content').attr('item_id')) {
					mui.toast('维护内容不能为空');
					return false;
				}
			} else {
				if (!$('#select_type').attr('item_id')) {
					mui.toast('养护类别不能为空');
					return false;
				}
				// if (!$('#select_item').attr('item_id')) {
				// 	mui.toast('养护项目不能为空');
				// 	return false;
				// }
			}


			if ($("#selectDate").html() == "请选择...") {
				mui.toast('报告时间不能为空');
				return false;
			}

			if (!$("#textarea_before").val()) {
				mui.toast('维修前描述不能为空');
				return false;
			}
			if ($("#img_list_before .img-selected").length == 0) {
				mui.toast('维修前照片不能为空');
				return false;
			}
			if (!$("#textarea_after").val()) {
				mui.toast('维修后描述不能为空');
				return false;
			}
			if ($("#img_list_after .img-selected").length == 0) {
				mui.toast('维修后照片不能为空');
				return false;
			}
			if (!$("#textarea_middle").val()) {
				mui.toast('维修中描述不能为空');
				return false;
			}
			if ($("#img_list_middle .img-selected").length == 0) {
				mui.toast('维修中照片不能为空');
				return false;
			}
			return true
		}

		function init_pickers() {
			// console.log("init_pickers()")
			var select_facility = document.getElementById('select_facility');
			var select_content = document.getElementById('select_content');
			var select_type = document.getElementById('select_type');
			// var select_item = document.getElementById('select_item');
			var select_unit = document.getElementById('select_unit');
			select_facility.addEventListener('tap', function(event) {
				alert('444')
				name_picker.show(function(items) {
					facility_id = items[0]["value"]
					select_facility.innerText = items[0]["text"];
					$('#select_facility').attr('item_id', items[0]["value"]);

					init_content()
				})
			})
			select_type.addEventListener('tap', function(event) {
				type_picker.show(function(items) {
					categoryName = items[0]["text"]
					select_type.innerText = items[0]["text"] ? items[0]["text"] : "请选择..";
					$('#select_type').attr('item_id', items[0]["value"]);

					init_item()
				})
			})
			// select_item.addEventListener('tap', function(event) {
			// 	item_picker.show(function(items) {
			// 		select_item.innerText = items[0]["text"] ? items[0]["text"] : "请选择..";
			// 		$('#select_item').attr('item_id', items[0]["value"]);
			// 	})
			// })
			select_content.addEventListener('tap', function(event) {
				content_picker.show(function(items) {
					select_content.innerText = items[0]["text"] ? items[0]["text"] : "请选择..";
					$('#select_content').attr('item_id', items[0]["value"]);
				})
			})
			select_unit.addEventListener('tap', function(event) {
				unit_picker.show(function(items) {
					select_unit.innerText = items[0]["text"] ? items[0]["text"] : "请选择..";
					$('#select_unit').attr('item_id', items[0]["value"]);
				})
			})
		}
		//初始化设施选择
		function init_facility_list() {
			// console.log("init_facility_list执行了")
			clearTimeout(timer)
			timer = setTimeout(function() {
				// console.log("init_facility_list setTimeout 执行了")
				var facility_name_data = [];
				var wDlg = plus.nativeUI.showWaiting("加载中...");
				var post_data = {
					uid: app.getUserId(),
					// company_id: cp_id,
					page_size: 30,
					page_no: 1,
					facility_name: $.trim($("#facility_input_name").val())
				}
				if (maintenaceRepairType) {
					post_data.maintenaceRepairType = maintenaceRepairType
				}
				// console.log(JSON.stringify(post_data))
				app.ajax(app.url('query/facility_list'), post_data, function(ret) {
					wDlg.close();
					if (ret.code == 0) {
						var data = ret.data.items;
						//					console.log(JSON.stringify(data))
						for (var i = 0; i < data.length; i++) {
							facility_name_data.push({
								value: data[i]["id"],
								text: data[i]["name"]
							})
						}
						name_picker.setData(facility_name_data);

					} else {
						mui.toast('获取设施列表失败：' + ret.error);
					}
				});
			}, 600)
		}
		//养护类别初始化
		function init_type() {
			// console.log("init_problem_type")
			type_picker.setData([]);
			if (init_flag) {
				$('select_type').attr('item_id', '');
				$('select_type').attr('item_name', '');
				$('select_type').text('请选择..');
			}
			app.ajax(app.url1('conservancyMaintenance/queryMainEntryCategory'), {}, function(ret) {
				// console.log(JSON.stringify(ret))
				if (ret.code == 200) {
					var arr = [];
					for (var i = 0; i < ret.data.length; ++i) {
						arr.push({
							value: ret.data[i],
							text: ret.data[i],
						})
					}
					type_picker.setData(arr);
				} else {
					mui.toast('获取养护类别失败：' + ret.error);
				}
			})
		}
		//养护项目初始化
		function init_item() {
			// console.log("init_item")
			item_picker.setData([]);
			if (init_flag) {
				// $('#select_item').attr('item_id', '');
				// $('#select_item').attr('item_name', '');
				// $('#select_item').text('请选择..');
			}
			app.ajax(app.url1('/conservancyMaintenance/queryEntryByCategory'), {
				categoryName: categoryName
			}, function(ret) {
				// console.log(JSON.stringify(ret))
				if (ret.code == 200) {
					var arr = [];
					for (var i = 0; i < ret.data.length; ++i) {
						arr.push({
							value: ret.data[i]["entryId"],
							text: ret.data[i]["entryName"],
						})
					}
					item_picker.setData(arr);
				} else {
					mui.toast('获取养护项目失败：' + ret.error);
				}
			})
		}
		//维护内容初始化
		function init_content() {
			// console.log("init_content")
			console.log(JSON.stringify({
				facilityInfoId: facility_id
			}))
			content_picker.setData([]);
			if (init_flag) {
				$('#select_content').attr('item_id', '');
				$('#select_content').attr('item_name', '');
				$('#select_content').text('请选择..');
			}
			app.ajax(app.url1('repair/findDeclaration'), {
				facilityInfoId: facility_id
			}, function(ret) {
				// console.log(JSON.stringify(ret))
				if (ret.code == 200) {
					var arr = [];
					for (var i = 0; i < ret.data.length; ++i) {
						arr.push({
							value: ret.data[i]["id"],
							text: ret.data[i]["repairContent"],
						})
					}
					content_picker.setData(arr);
				} else {
					mui.toast('获取维护内容失败：' + ret.error);
				}
			})
		}
		//单位初始化
		function init_unit() {
			unit_picker.setData([{
					value: "只",
					text: "只",
				},
				{
					value: "根",
					text: "根",
				},
				{
					value: "件",
					text: "件",
				},
				{
					value: "艘",
					text: "艘",
				},
				{
					value: "台",
					text: "台",
				},
				{
					value: "把",
					text: "把",
				},
				{
					value: "双",
					text: "双",
				},
				{
					value: "个",
					text: "个",
				},
				{
					value: "捆",
					text: "捆",
				},
				{
					value: "kg",
					text: "kg",
				},
				{
					value: "米",
					text: "米",
				},
				{
					value: "套",
					text: "套",
				},
				{
					value: "箱",
					text: "箱",
				},
				{
					value: "节",
					text: "节",
				},
				{
					value: "包",
					text: "包",
				},
				{
					value: "部",
					text: "部",
				},
				{
					value: "圈",
					text: "圈",
				},
				{
					value: "卷",
					text: "卷",
				}
			])
		}

		var timer;

		mui.plusReady(function() {
			plus.screen.lockOrientation("portrait-primary");
		});

		function addEventLongTap(pic_pop, img_warp) {
			//'img_action_list_before','img_list_before'
			var arrItems = document.querySelectorAll("#" + img_warp + ' .img-selected');

			[].forEach.call(arrItems, function(item) {
				item.addEventListener('longtap', function() {
					currentImgItem = this;
					mui('#' + pic_pop).popover('toggle');
				})
			});
		}

		function add_img(pic_pop, img_warp) {
			if (document.querySelectorAll('#' + img_warp + ' .img-selected').length >= app.max_count_photos) {
				mui.toast('取证照片已至最大数量');
				return;
			}

			mui('#' + pic_pop).popover('toggle');
		}

		function del_img(pic_pop, img_warp) {
			if (currentImgItem) {
				currentImgItem.parentNode.removeChild(currentImgItem);
				currentImgItem = null;
			}

			mui('#' + pic_pop).popover('toggle');
		}

		function getImage(pic_pop, del_pop, img_warp) {
			var cmr = plus.camera.getCamera();
			cmr.captureImage(function(path) {
				//				console.log('get image ' + path);
				//				addImg(path);

				plus.gallery.save(path, function(event) {
					plus.io.resolveLocalFileSystemURL(path, function(entry) {
						addImg("file://" + entry.fullPath, pic_pop, del_pop, img_warp);
					}, function(e) {
						console.log('路径解析失败: ' + JSON.stringify(e));
					});
				}, function(e) {
					console.log('保存失败: ' + JSON.stringify(e));
				});
			}, function(e) {
				//			console.log(JSON.stringify(e));
			}, {
				filename: '_doc/gallery/',
				index: 1
			});

			mui('#' + pic_pop).popover('toggle');
		}

		function addImg(strSrc, pic_pop, del_pop, img_warp) {
			// console.log("#" + img_warp);

			plus.io.resolveLocalFileSystemURL(strSrc, function(entry) {
				//			console.log(entry);
				entry.getMetadata(function(metadata) {
					// console.log("源文件大小="+metadata.size/1024/1024+"M");
					if (metadata.size > 1024 * 1024) // 1M
					{
						// comparess image
						var nPtPos = strSrc.lastIndexOf('.');
						var strDst = '';
						if (nPtPos > 0) {
							strDst = strSrc.substr(0, nPtPos) + '_s50' + strSrc.substr(nPtPos);
						} else {
							strDst = strSrc + '_s50';
						}
						//					console.log('dist ' + strDst);

						// compress image
						var wUI = plus.nativeUI.showWaiting('压缩中...');
						plus.zip.compressImage({
								src: strSrc,
								dst: strDst,
								overwrite: true,
								width: '100%',
								height: '100%',
								quality: 80
							},
							function(e) {
								wUI.close();

								// add image
								//							console.log('compress size: ' + e.size);

								//							console.log(e.target);
								var newImg = document.createElement('img');
								newImg.src = e.target;
								newImg.classList.add("img-selected");

								newImg.addEventListener('longtap', function() {
									currentImgItem = this;
									mui('#' + del_pop).popover('toggle');
								})

								document.getElementById(img_warp).appendChild(newImg);
							},
							function(e) {
								wUI.close();
								mui.toast('压缩文件失败：' + e.message);
							})
					} else {
						var newImg = document.createElement('img');
						newImg.src = strSrc;
						newImg.classList.add("img-selected");

						newImg.addEventListener('longtap', function() {
							currentImgItem = this;
							mui('#' + del_pop).popover('toggle');
						})

						document.getElementById(img_warp).appendChild(newImg);
					}
				}, function(err) {
					mui.toast('打开文件错误');
				})
			});
		}

		function galleryImgsMaximum(pic_pop, del_pop, img_warp) {
			var maxValue = app.max_count_photos - document.querySelectorAll("#" + img_warp + ' .img-selected').length;
			if (maxValue < 0)
				maxValue = 0;

			if (maxValue == 0) {
				alert('取证图片已选至最大数量');
				mui('#' + pic_pop).popover('toggle');
				return;
			}

			// 从相册中选择图片
			plus.gallery.pick(function(e) {
				for (var i in e.files) {
					addImg(e.files[i], pic_pop, del_pop, img_warp);
				}
			}, function(e) {
				//	outSet('取消选择图片');
			}, {
				filter: 'image',
				multiple: true,
				maximum: maxValue,
				system: false,
				onmaxed: function() {
					plus.nativeUI.alert('最多只能选择' + maxValue + '张图片');
				}
			}); // 最多选择3张图片

			mui('#' + pic_pop).popover('toggle');
		}

		var count = 0;
		var file_data_arr = [];
		var fg = true;

		//上传
		function upload() {
			// console.log("uploadImg")
			plus.nativeUI.showWaiting('数据上传中...');
			var xhr = new XMLHttpRequest();
			xhr.timeout = 120000;
			xhr.ontimeout = function(e) {
				mui.toast('请求超时，请再网络状态良好的地方重试');
				upload.close()
			};
			
			var sum = 0;
			var formData = new FormData();
			for (var i = 0; i < file1_data_arr.length; i++) {
				// console.log("file1--->"+file1_data_arr[i].size);
				sum+=file1_data_arr[i].size;
				formData.append('file1', file1_data_arr[i]);
			}
			for (var i = 0; i < file2_data_arr.length; i++) {
				// console.log("file2--->"+file1_data_arr[i].size);
				sum+=file2_data_arr[i].size;
				formData.append('file2', file2_data_arr[i]);
			}
			// console.log("file3 size--->"+file3_data_arr.length);
			for (var i = 0; i < file3_data_arr.length; i++) {
				// console.log("file3--->"+file1_data_arr[i].size);
				sum+=file3_data_arr[i].size;
				formData.append('file3', file3_data_arr[i]);
			}
			console.log("files size--->"+sum);
			if(sum>1000000){
				plus.nativeUI.closeWaiting();
				mui.toast("上传文件大小不能超过10M！");
				return;
			}
			// maintenaceRepairType:8802 //8801设施养护、8802设施维修
			// facilityInfoId:22 //设施id
			// deviceSerialNumber: //具体设备号，可以为空
			// entityInfoId:14 //养护、维修项目id
			// expenseMoney:70.00 //花费，可以为空
			// processStage:8003 //所处阶段，8001 维护前、8002维护中、8003维护完成
			// remark:养护完成 //备注信息
			// rectificationSerial: //养护、维修编号,可以为空
			// files: 请选择图片  //养护、维修图片数组
			formData.append("maintenaceRepairType", maintenaceRepairType);
			formData.append("facilityInfoId", $('#select_facility').attr('item_id'));

			if (maintenaceRepairType == 8802) {
				formData.append("entityInfoId", $('#select_content').attr('item_id'));
			} else {
				// formData.append("entityInfoId", $('#select_item').attr('item_id'));
			}

			formData.append("processStage", processStage);

			var maintenaceRepairTime = app.getFormatDayTime();
			formData.append("maintenaceRepairTime", maintenaceRepairTime);

			var expenseMoney = "1.0";
			formData.append("expenseMoney", expenseMoney);

			formData.append("dsc1", $("#textarea_before").val());
			formData.append("dsc2", $("#textarea_middle").val());
			formData.append("dsc3", $("#textarea_after").val());

			// if (processStage == 8001) {
			// 	formData.append("remark", $("#textarea_before").val());
			// } else if (processStage == 8002) {
			// 	formData.append("remark", $("#textarea_middle").val());
			// } else {
			// 	formData.append("remark", $("#textarea_after").val());
			// }

			if ($("#unit_count").val()) {
				formData.append("number", $("#unit_count").val());
			}
			if ($("#select_unit").attr("item_id")) {
				formData.append("unit", $("#select_unit").attr("item_id"));
			}


			// formData.append("reportDate", $("#selectDate").html());
			xhr.onreadystatechange = function(e) {
				if (xhr.readyState == 4) {
					plus.nativeUI.closeWaiting();
					// console.log("上传结果：" + xhr.responseText)
					var ret = JSON.parse(xhr.responseText);
					file_data_arr = [];
					count = 0;
					fg = true;
					if (xhr.status == 200) {
						if (ret.code == 200) {
							// 							console.log("processStage：" + processStage)
							// 							if (processStage == 8001) {
							// 								// mui.toast('维修前数据上传成功');
							// 								processStage = 8002;
							// 								start_upload()
							// 							} else if (processStage == 8002) {
							// 								processStage = 8003;
							// 								start_upload()
							// 								// mui.toast('维修中数据上传成功');
							// 							} else {
							// 								mui.toast('维修数据上传成功');
							// 								var parentViewer = mui.currentWebview.opener();
							// 								var arr = JSON.parse(app.getSetting("maintenace_report" + user_id) || "[]")
							// 								if (uuid) {
							// 									for (var i = 0; i < arr.length; i++) {
							// 										if (arr[i]["list_info"]["uuid"] == uuid) {
							// 											arr.remove(arr[i])
							// 										}
							// 									}
							// 								}
							// 
							// 								app.setSetting("maintenace_report" + user_id, JSON.stringify(arr));
							// 								mui.fire(parentViewer, 'wga_refresh');
							// 								app.ajaxBack();
							// 							}
							mui.toast('维修数据上传成功');
							var parentViewer = mui.currentWebview.opener();
							var arr = JSON.parse(app.getSetting("maintenace_report" + user_id) || "[]")
							if (uuid) {
								for (var i = 0; i < arr.length; i++) {
									if (arr[i]["list_info"]["uuid"] == uuid) {
										arr.remove(arr[i])
									}
								}
							}

							app.setSetting("maintenace_report" + user_id, JSON.stringify(arr));
							mui.fire(parentViewer, 'wga_refresh');
							app.ajaxBack();
						} else {
							mui.toast(get_error_msg(ret, '上传失败，请重新保存'));
						}
					} else {
						mui.toast(get_error_msg(ret, '上传失败，请重新保存'));
					}
				}
			}

			xhr.open('POST', app.url1('conservancyMaintenance/addMainRepair'), true);
			xhr.send(formData);
		}

		//将图片转换为Base64
		function getImgToBase64(arr, file_data_arr, size, index) {
			for (var i = 0; i < arr.length; i++) {
				loadImage(arr[i]).then(function(file) {
						file_data_arr.push(file);
						// console.log(file.name);
						// console.log("+++" + file_data_arr);
						if (file_data_arr.length == size) {
							if (index == 0) {
								getImgToBase64(file2Arr, file2_data_arr, file2Arr.length, 1);
							} else if (index == 1) {
								getImgToBase64(file3Arr, file3_data_arr, file3Arr.length, 2);
							} else if (index == 2) {
								upload();
								// alert("加载图片完毕啦！")
							}
						}
					})
					.catch(function(reason, data) {
						console.log('catch到rejected失败回调');
						console.log('catch失败执行回调抛出失败原因：', reason);
						// if(upload){
						// 	upload.close();
						// }
					});
			}
		}

		function loadImage(file) {
			return new Promise(function(resolve, reject) {
				var canvas = document.createElement('canvas'),
					ctx = canvas.getContext('2d'),
					img = new Image;
				img.crossOrigin = 'Anonymous';
				img.onload = function() {
					var originWidth = img.width;
					var originHeight = img.height;
					// 最大尺寸限制
					var maxWidth = app.maxWidth(),
						maxHeight = app.maxWidth();
					// 目标尺寸
					var targetWidth = originWidth,
						targetHeight = originHeight;
					// 图片尺寸超过1000x1000的限制
					if (originWidth > maxWidth || originHeight > maxHeight) {
						if (originWidth / originHeight > maxWidth / maxHeight) {
							targetWidth = maxWidth;
							targetHeight = Math.round(maxWidth * (originHeight / originWidth));
						} else {
							targetHeight = maxHeight;
							targetWidth = Math.round(maxHeight * (originWidth / originHeight));
						}
					}
					// canvas对图片进行缩放
					canvas.width = targetWidth;
					canvas.height = targetHeight;
					// 清除画布
					ctx.clearRect(0, 0, targetWidth, targetHeight);
					// 图片压缩
					ctx.drawImage(img, 0, 0, targetWidth, targetHeight);
					ctx.font = targetWidth / 20 + "px microsoft yahei";
					ctx.fillStyle = "rgba(255,128,0,1)";
					var txt = save_time ? save_time : current_time
					var pos_x = targetWidth - ctx.measureText(txt).width
					var pos_y = targetHeight - targetWidth / 20
					ctx.fillText(txt, pos_x, pos_y);
					// console.log(targetWidth, targetHeight)
					var dataURL = canvas.toDataURL('image/jpeg');
					var arr = file.split("/");
					resolve(dataURLtoFile(dataURL, arr[arr.length - 1]));
					canvas = null;
				};
				img.src = file;
			})
		}

		//将base64转换为文件
		function dataURLtoFile(dataurl, filename) {
			var arr = dataurl.split(','),
				mime = arr[0].match(/:(.*?);/)[1],
				bstr = atob(arr[1]),
				n = bstr.length,
				u8arr = new Uint8Array(n);
			//					console.log(mime)
			while (n--) {
				u8arr[n] = bstr.charCodeAt(n);
			}
			return new File([u8arr], filename, {
				type: mime
			});
		}
	</script>
</html>
