<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<link href="../../asset/css/mui.min.css" rel="stylesheet" />
		<link href="../../asset/css/iconfont.css" rel="stylesheet" />
		<link href="../../asset/css/mui.picker.min.css" rel="stylesheet" />
		<link href="../../asset/css/mui.poppicker.css" rel="stylesheet" />
		<link href="../../asset/css/style.css" rel="stylesheet" /> 
		<style>
			#list-option .mui-table-view-cell button {
				position: relative;
				right: inherit;
				-webkit-transform: inherit;
				transform: inherit;
			}
			
			.mui-table-view span.mui-pull-right {
				color: #999;
			}
			
			.img-selected {
				width: 80px;
				height: 80px;
				margin-top: 10px;
			}
			/* 
			#device_li {
				display: none;
			} */
		</style>
	</head>

	<body onload="app.route()">
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<span id="scan_qr"  onclick="clicked('../../barcode_scan.html',true,true)" class=" mui-btn mui-btn-link mui-pull-left   iconfont icon-im_erweimasaomiao" style="font-weight:bold;font-size:18px;padding: 0 10px;margin-left:20px;"></span>
		 
			<a class="mui-btn mui-btn-link mui-pull-right btn_cancel">取消</a>
			<a class="mui-btn mui-btn-link mui-pull-right btn_submit">上传</a>
			<a class="mui-btn mui-btn-link mui-pull-right save_btn">保存</a>
			<h1 class="mui-title">水利整改单</h1>
		</header>
		<div class="mui-content">
			<ul id="list-option" class="mui-table-view">
				<li class="mui-table-view-cell">
					<i class="iconfont icon-dituleiwanggequ"></i> 设施名称
					<span id="select_facility" style="max-width: 100%;" class="mui-pull-right mui-ellipsis">请选择..</span>
					<input type="text" id="facility_input_name" placeholder="输入设施名称" style="width: 88px;padding: 0;margin: 0;line-height: 23px;height: 25px;float: right;    margin-right: 10px;font-size: 12px;"/>
				</li>
				<li class="mui-table-view-cell">
					<i class="iconfont icon-xunjiandengji"></i> 问题点
					<span id="select_problem_point" style="max-width: 100%;" class="mui-pull-right mui-ellipsis">请选择..</span>
				</li>
				<li id="device_li" class="mui-table-view-cell">
					<i class="iconfont icon-erji-yunweibaobiao"></i> 问题设备
					<span id="selectDevice" style="max-width: 100%;" class="mui-pull-right mui-ellipsis">请选择..</span>
				</li>
				<li class="mui-table-view-cell mui-hidden"  >
					<i class="iconfont icon-wenhaoxiao"></i> 问题内容
					<span id="select_problem_content" style="max-width: 100%;" class="mui-pull-right mui-ellipsis">请选择..</span>
				</li>
				
				<li  class="mui-table-view-cell">
					<i class="iconfont icon-list4f"></i> 问题类型
					<span id="select_problem_type" style="max-width: 100%;" class="mui-pull-right mui-ellipsis">请选择..</span>
				</li>
				<li  class="mui-table-view-cell" >
					<i class="iconfont icon-detail"></i> 问题项目
					
					<span id="select_problem_item" style="max-width: 100%;" class="mui-pull-right mui-ellipsis">请选择..</span>
					<input type="number" id="select_person_count" placeholder="" style="width: 44px;padding: 0;margin: 0;line-height: 23px;height: 25px;float: right;    margin-right: 10px;font-size: 12px;display: none;"/>
				</li>

				<li class="mui-table-view-cell">
					<i class="iconfont icon-date1"></i> 报告时间
					<span id="selectDate" style="max-width: 100%;" class="mui-pull-right mui-ellipsis">请选择...</span>
				</li>

				<li class="mui-table-view-cell">
					<p>检查情况说明：</p><br>
					<textarea id="textarea" rows="3" placeholder="请输入描述信息"></textarea>
				</li>
				<li class="mui-table-view-cell">
					<p>检查问题照片 (最多
						<span id="max_photos">3</span>张) (长按删除)
						<button onclick="add_img()" class="mui-btn mui-btn-primary mui-btn-outlined mui-pull-right">
                    <i class="iconfont icon-add"></i>
                </button>
					</p>
					<br>
					<div id="img_list">
						<!--
                <img src="images/evid1.png" class="img-selected">
                <img src="images/evid1.png" class="img-selected">
                <img src="images/evid1.png" class="img-selected">
                -->
					</div>
				</li>
				<li class="mui-table-view-cell" style="display: none;">
					<i class="iconfont icon-zijin"></i> 所需资金
					<span class="mui-pull-right">(元)</span>
					<input type="number" class="mui-pull-right" style="margin-right:5px;width: 30vw;height: 24px;" />
				</li>
			</ul>

		</div>

		<div id="picture" class="mui-popover mui-popover-action mui-popover-bottom">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a onclick="getImage()">拍照</a>
				</li>
				<li class="mui-table-view-cell">
					<a onclick="galleryImgsMaximum()">选取现有的</a>
				</li>
			</ul>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a href="#picture"><b>取消</b></a>
				</li>
			</ul>
		</div>

		<div id="img_action_list" class="mui-popover mui-popover-action mui-popover-bottom">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a onclick="del_img()">删除</a>
				</li>
			</ul>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a href="#img_action_list"><b>取消</b></a>
				</li>
			</ul>
		</div>

	</body>
	<script src="../../asset/js/jquery-3.3.1.min.js"></script>
	<script src="../../asset/js/mui.min.js"></script>
	<script src="../../asset/js/mui.picker.min.js"></script>
	<script src="../../asset/js/mui.poppicker.js"></script>
	<script src="../../asset/js/app.js"></script>
	<script type="text/javascript" src="../../asset/js/common.js"></script>
	<script type="text/javascript" charset="utf-8">
		var user_data = app.getUserInfo();
		var user_id = user_data.id
		var uuid = app.getUrlParam('uuid');
		var inspectionType = app.getUrlParam('inspectionType');
		var save_time = ""
		var pointPicker = new mui.PopPicker();
		var devicePicker = new mui.PopPicker();
		var namePicker = new mui.PopPicker();
		var select_problem_type_picker =  new mui.PopPicker();//问题类容
		var select_problem_item_picker =  new mui.PopPicker();//问题项目
		var problem_content_picker= new mui.PopPicker();
		var addressPicker = new mui.PopPicker();
		var current_device_id = '';
		var current_device_name = '';
		var need_problem_device = false;
		var need_point = false;
		var is_from_register = false;
		var is_from_register_fg = true;
		var device_list_count = 0;
		var current_time = new Date().format("yyyy-MM-dd hh:mm:ss")
		
		if(uuid) {
			var problem_report_data = JSON.parse(app.getSetting("problem_report"+user_id) || "[]");
			for(var i = 0; i < problem_report_data.length; i++) {
				if(uuid == problem_report_data[i]["list_info"]["uuid"]) {
					save_time = problem_report_data[i]["list_info"]["save_time"]
					$(".mui-content").html(problem_report_data[i]["data"]["html"])
					$("#textarea").val(problem_report_data[i]["post_json"]["memo"])
					level1_id = problem_report_data[i]["data"]["level1_id"]
					level2_id = problem_report_data[i]["data"]["level2_id"]
					level3_id = problem_report_data[i]["data"]["level3_id"]
					level1_name = problem_report_data[i]["data"]["level1_name"]
					level2_name = problem_report_data[i]["data"]["level2_name"]
					level3_name = problem_report_data[i]["data"]["level3_name"]
					current_device_id = problem_report_data[i]["data"]["device_id"];
					current_device_name =  problem_report_data[i]["data"]["problemDeviceName"];
					var select_facility = document.getElementById('select_facility');
					var select_problem_point = document.getElementById('select_problem_point');
					var select_problem_content = document.getElementById('select_problem_content');
					var selectDate = document.getElementById('selectDate');
					current_time =  selectDate.innerHTML = problem_report_data[i]["post_json"]["reportDate"]
					$("#textarea").val(problem_report_data[i]["post_json"]["rectificationReason"])
					level2_add_data(problem_report_data[i]["data"]["init_level2_arr"],problem_report_data[i]["data"]["init_level2_check_item_item_obj"])
					level3_add_data(problem_report_data[i]["data"]["init_level2_arr_item"])
					select_problem_item_picker.setData(problem_report_data[i]["data"]["init_problem_item_arr"]) 
					inspectionType = inspectionType?inspectionType:problem_report_data[i]["post_json"]["inspectionType"]
				}
			}
			if(current_device_name)
			{
				$('#selectDevice').attr('item_name', current_device_name);
				$('#selectDevice').text(current_device_name);
				// need_problem_device = true;
			}
// 			if(need_problem_device)
// 			{
// 				$('#device_li').show();
// 				$('#selectDevice').attr('item_name', current_device_name);
// 				$('#selectDevice').text(current_device_name);
// 			}
// 			else
// 			{
// 				$('#device_li').hide();
// 			}
			$(".btn_submit").show()
			$(".save_btn").hide()
		} else {
			var select_facility = document.getElementById('select_facility');
			var select_problem_point = document.getElementById('select_problem_point');
			var select_problem_content = document.getElementById('select_problem_content');
			var selectDate = document.getElementById('selectDate');
			app.get_time(function(ret){
				// console.log("get_time:=====>"+ret)
				current_time = selectDate.innerHTML =    ret
			})
			// selectDate.innerHTML = new Date().format("yyyy-MM-dd hh:mm:ss")
			var level1_id = app.getUrlParam('level1_id');
			var level2_id = app.getUrlParam('level2_id');
			var level3_id = app.getUrlParam('level3_id');
			var level4_id = app.getUrlParam('level4_id'); // device id
			var level1_name = app.getUrlParam('level1_name');
			var level2_name = app.getUrlParam('level2_name');
			var level3_name = app.getUrlParam('level3_name');
			var level4_name = app.getUrlParam('level4_name'); // device name
			
			//判断是不是从巡检登记 过来的
			if(level1_id && level2_id ){
				$('#select_facility').attr('item_id',level1_id);
				$('#select_problem_point').attr('item_id',level2_id);
				$(".btn_submit").show()
				$(".save_btn").hide()
				$("#facility_input_name").hide()
				$("#scan_qr").hide()
				is_from_register = true;
			}else{
				$(".btn_submit").hide()
				$(".save_btn").show()
				$("#facility_input_name").show()
			}
			
			if(level4_id && level4_name)
			{
				$('#selectDevice').attr('item_id', level4_id);
				$('#selectDevice').attr('item_name', level4_name);
				$('#selectDevice').text(level4_name);
				
				// need_problem_device = true;
			}
			
// 			if(need_problem_device)
// 			{
// 				$('#device_li').show();
// 				$('#selectDevice').attr('item_id', level4_id);
// 				$('#selectDevice').attr('item_name', level4_name);
// 				$('#selectDevice').text(level4_name);
// 			}
// 			else
// 			{
// 				$('#device_li').hide();
// 			}
		}
		var init_level2_arr;
		var init_level2_check_item_item_obj;
		var init_level2_arr_item;
		var init_problem_item_arr;
		if(level1_name) select_facility.innerHTML = level1_name
		if(level2_name) select_problem_point.innerHTML = level2_name
		if(level3_name) select_problem_content.innerHTML = level3_name
		inspectionType = inspectionType?inspectionType:8501,inspectionType
		if(inspectionType==8502){
			$(".mui-title").html("维护整改单")
			$("#select_problem_type").parent().hide()
			$("#select_problem_item").parent().hide()
		}
		var user_data = app.getUserInfo();
		var cp_id = user_data.company_id

		var addImage = document.getElementById('addImage');
		document.getElementById('max_photos').innerText = app.max_count_photos;
		
		if(!is_from_register)
		{
// 			initCtrls();
// 			init_facility_list();
		}
		
		mui.ready(function() {
			$(".btn_cancel").click(function(){
				mui.confirm('确定还原初始界面吗？', '初始界', ['否', '是'], function(e) {
					// console.log(e.index)
					if(e.index == 1) {
						window.location.reload()
	//					mui.toast("还原成功")
					} else {
	
					}
				})
			})
			
			mui.init({
				gestureConfig: {
					longtap: true
				}
			});
			initCtrls();
			init_facility_list();
// 			if(!level1_id && !level2_id ) {
// 				init_facility_list()
// 			}
			init_problem_type_list()
			var timerInputName = 0;
			document.getElementById("facility_input_name").addEventListener('input', function() {
				if(timerInputName != 0)
				{
					clearTimeout(timerInputName);
					timerInputName = 0;
				}
				timerInputName = setTimeout(function(){
					init_facility_list();
				},1000);
			});

			document.getElementById("facility_input_name").addEventListener('tap', function() {
				$('#facility_input_name').focus();
			});
			
			document.getElementById('selectDate').addEventListener('tap', function() {
				app.pickDate(this, true);
			}, false);

			addEventLongTap();

			$(".btn_submit").click(function() {
				//保存
				saveData();
			})
		})
		var timer;
		var check_item_obj;
		var check_item_item_obj;
		//初始化设施选择
		function init_facility_list(){
			// console.log("init_facility_list执行了")
			clearTimeout(timer)
			timer = setTimeout(function() {
				// console.log("init_facility_list setTimeout 执行了")
				var facility_name_data = [];
				var wDlg = plus.nativeUI.showWaiting("加载中...");
				
				var post_level1_name = level1_name?level1_name:$.trim($("#facility_input_name").val());
				var post_data = {
					uid:app.getUserId(),
					// company_id: cp_id,
					page_size: 30,
					page_no: 1,
					facility_name: $.trim($("#facility_input_name").val())
				}
				if(inspectionType){
					post_data.inspectionType = inspectionType?inspectionType:8501
				}
				// console.log(JSON.stringify(post_data))
				app.ajax(app.url('query/facility_list'),post_data, function(ret) {
					wDlg.close();
					// console.log(JSON.stringify(ret))
					if(ret.code == 0 ) {
						var data = ret.data.items;
						check_item_obj = {}
						//					console.log(JSON.stringify(data))
						for(var i = 0; i < data.length; i++) {
							facility_name_data.push({
								value: data[i]["id"],
								text: data[i]["name"]
							})
	
							check_item_obj[data[i]["id"]] = data[i]["check_items"]
						}
						
						namePicker.setData(facility_name_data);
						if(is_from_register && is_from_register_fg){
							
							is_from_register_fg = false;
							var check_item = check_item_obj[level1_id]
							var arr = []
							check_item_item_obj = {}
							for(var i = 0; i < check_item.length; i++) {
								arr.push({
									value: check_item[i]["id"],
									text: check_item[i]["name"]
								})
								check_item_item_obj[check_item[i]["id"]] = check_item[i]["children"]
							}
							init_level2_arr = arr
							init_level2_check_item_item_obj = check_item_item_obj
							level2_add_data(arr, check_item_item_obj)

						}
						
					} else {
						mui.toast('获取设施列表失败：' + ret.error);
					}
				});
			},600)
		}
		
		$(".save_btn").click(function() {
			if(!level1_id) {
				mui.toast('设施名称不能为空');
				return false;
			}
			if(need_point && !level2_id) {
				mui.toast('问题点不能为空');
				return false;
			}
// 			if(need_problem_device && !$('#selectDevice').attr('item_id'))
// 			{
// 				mui.toast('问题设备不能为空');
// 				return false;
// 			}
// 			if(!level3_id) {
// 				mui.toast('问题内容不能为空');
// 				return false;
// 			}
			if(inspectionType!=8502){
				if(!$("#select_problem_type").attr('item_id')) {
					mui.toast('问题类型不能为空');
					return false;
				}
				if(!$("#select_problem_item").attr('item_id')) {
					mui.toast('问题项目不能为空');
					return false;
				}
			}
			
			
			if($("#selectDate").html() == "请选择...") {
				mui.toast('报告时间不能为空');
				return false;
			}
			if(!$("#textarea").val()) {
				mui.toast('检查情况说明不能为空');
				return false;
			}
			if($(".img-selected").length == 0) {
				mui.toast('检查问题照片不能为空');
				return false;
			}

			var arr;

//			app.setSetting("problem_report"+user_id, JSON.stringify([]));

			if(app.getSetting("problem_report"+user_id) == "") {
				arr = [];
			} else {
				arr = JSON.parse(app.getSetting("problem_report"+user_id) || "[]")
			}

			var var_uuid = uuid ? uuid : new Date().format("yyyyMMddhhmmssS")
			for(var i = 0; i < arr.length; i++) {
				if(arr[i]["list_info"]["uuid"] == var_uuid) {
					arr.remove(arr[i])
				}
			}
			var arr_imgs = new Array();
			$(".img-selected").each(function(key, value) {
				arr_imgs.push($(value).attr('src'))
			})
			
			mapData = {
					html: $(".mui-content").html(),
					level1_id: level1_id,
					level2_id: level2_id,
					level3_id: level3_id,
					level1_name: level1_name,
					level2_name: level2_name,
					level3_name: level3_name,
					
					init_level2_arr:init_level2_arr,
					init_level2_check_item_item_obj:init_level2_check_item_item_obj,
					init_level2_arr_item:init_level2_arr_item,
					init_problem_item_arr:init_problem_item_arr
			};
			
			if(inspectionType!=8502){
				mapData.problem_type = $("#select_problem_type").html()
				mapData.problem_item = $("#select_problem_item").html()
			}
			
			var date = new Date();
			var rectificationSerial = date.getFullYear()+""+(date.getMonth() + 1)+""+date.getDate()+""+date.getHours()
				+date.getMinutes()+""+date.getSeconds()+""+parseInt(Math.random()*10000);
			console.log("rectificationSerial--->"+rectificationSerial);
			jsonPost = {
					conservancyId: level1_id,
					targetId: level2_id,					
					subTargetId: level3_id,
					rectificationReason: $("#textarea").val(),
					reportDate: $("#selectDate").html(),
					inspectionType:inspectionType,
					rectificationSerial:rectificationSerial
			};
			
			if(inspectionType!=8502){
				mapData.rectificationType = $('#select_problem_type').attr('item_id')
				mapData.subProblemId = $('#select_problem_item').attr('item_id')
			}
			
			if($('#selectDevice').attr('item_name'))
			{
				mapData['device_id'] = $('#selectDevice').attr('item_id');
				jsonPost['problemDeviceName'] = mapData['problemDeviceName'] = $('#selectDevice').attr('item_name');
			}

			arr.push({
				list_info: {
					id: level1_id,
					name: level1_name,
					uuid: var_uuid,
					time: current_time,
					save_time: current_time,
					user_name: user_data.user_name
				},
				post_json: jsonPost,
				data: mapData,
				arr_imgs: arr_imgs,
				type:"problem_report",
				inspectionType:inspectionType
			})

			// console.log(JSON.stringify(arr));

			app.setSetting("problem_report"+user_id, JSON.stringify(arr));
			var parentViewer = mui.currentWebview.opener();
			mui.fire(parentViewer, 'wga_refresh');
			mui.toast('水利整改已保存，请至"信息流转/水利整改信息流转"中查看，请手动提交服务器');
			app.ajaxBack();
		})
		mui.plusReady(function() {
			plus.screen.lockOrientation("portrait-primary");
		});
		
		var arr_item;
		function level2_add_data(arr, acheck_item_item_obj) {
		 	check_item_item_obj = acheck_item_item_obj;
			pointPicker.setData(arr);
			
			init_device_list();
		}
		
		function level3_add_data(arr_item3) {
	 		arr_item = arr_item3
			problem_content_picker.setData(arr_item);
		}
		
		function init_device_list() {
			devicePicker.setData([]);
			$('selectDevice').attr('item_id','');
			$('selectDevice').attr('item_name','');
			$('selectDevice').text('请选择...');
			
			// console.log('init_device_list');
			console.log($('#select_facility').html())
			console.log($('#select_problem_point').html())
			
			var _facilityId = $('#select_facility').attr('item_id');
			var _pointId = $('#select_problem_point').attr('item_id');
			// console.log(_facilityId);
			// console.log(_pointId);
			if(!_facilityId || !_pointId || _facilityId == '' || _pointId == '')
			{
				return;
			}
				
// 			var point_name = $('#select_problem_point').text();
// 			console.log("point_name:"+point_name)
// 			var var_need_problem_device = false;
// 			if(point_name)
// 				var_need_problem_device = point_name.indexOf('闸门') >= 0 || point_name.indexOf('启闭机') >= 0 || point_name.indexOf('水泵') >= 0;
// 				
			//两种情况问题设施展示
			//1 存在问题类型 日常养护 
			//2 不存在 看
// 			if($('#select_problem_type').attr('item_id')){
// 				if(select_problem_type.innerText =="日常养护")
// 				{
// 					// $('#device_li').show(); 
// 				}
// 				else
// 				{
// 					$('#device_li').hide();
// 					return;
// 				}
// 			}else{
// 				if(var_need_problem_device )
// 				{
// 					// $('#device_li').show(); 
// 				}
// 				else
// 				{
// 					$('#device_li').hide();
// 					return;
// 				}
// 			}
			
			
			
// 			if(is_from_register)
// 				return;
			
			// console.log(JSON.stringify({facilityId:_facilityId,targetId: _pointId}));
			app.ajax(app.url1('inspection/getDeviceSerial'),{facilityId:_facilityId,targetId: _pointId},function(ret){
				// console.log(JSON.stringify(ret))
				if(ret.code == 200)
				{
					var arr = [];
// 					device_list_count = ret.data.length;
// 					if($('#select_problem_type').attr('item_id')){
// 						if(select_problem_type.innerText =="日常养护" &&  device_list_count>0){
// 							need_problem_device = true;
// 							$('#device_li').show();
// 							
// 						}else{
// 							need_problem_device = false;
// 							$('#device_li').hide();
// 						}
// 					}else{
// 						if(var_need_problem_device &&  device_list_count>0){
// 							$('#device_li').show();
// 						}else{
// 							need_problem_device = false;
// 							$('#device_li').hide();
// 						}
// 					}
					
					for(var i = 0; i < ret.data.length; ++i)
					{
						var item_name = ret.data[i]["deviceName"] ? ret.data[i]["deviceName"] : (ret.data[i]["gateName"] ? ret.data[i]["gateName"] : ret.data[i]["pumpName"]);
						arr.push({
							value: ret.data[i]["deviceSerialNumber"],
							text: item_name
						})
						
						if(current_device_id && current_device_id == ret.data[i]["deviceSerialNumber"])
						{
							$('#selectDevice').attr('item_id', current_device_id);
							$('#selectDevice').attr('item_name', item_name);
							$('#selectDevice').text(item_name);
						}
					}
					
					devicePicker.setData(arr);
				}
				else
				{
					mui.toast('获取设备列表失败：' + ret.error);
				}
			})
		}
		function init_problem_type_list() {
			// console.log("init_problem_type_list")
			select_problem_type_picker.setData([]);
			$('select_problem_type').attr('item_id','');
			$('select_problem_type').attr('item_name','');
			$('select_problem_type').text('请选择...');
			// console.log(app.url1('item/findQuestionItem'))
			app.ajax(app.url1('item/findQuestionItem'),{},function(ret){
				// console.log(JSON.stringify(ret))
				if(ret.code == 200)
				{
					var arr = [];
					for(var i = 0; i < ret.data.length; ++i)
					{
						var item_arr = []
						var item = ret.data[i]
						for (var j = 0; j < item["list"].length; j++) {
							item_arr.push({
								value: item["list"][j]["id"],
								text: item["list"][j]["subtypeName"]
							})
						}
						arr.push({
							value: item["id"],
							text: item["categoryName"],
							child_json:JSON.stringify(item_arr)
						})
						
						
					}
					
					select_problem_type_picker.setData(arr);
				}
				else
				{
					mui.toast('获取设备列表失败：' + ret.error);
				}
			})
		}
		
		function init_problem_item_list() {
			// console.log("init_problem_item_list")
			select_problem_item_picker.setData([]);
			$('select_problem_item').attr('item_id','');
			$('select_problem_item').attr('item_name','');
			$('select_problem_item').text('请选择...');
			select_problem_item_picker.setData(arr);
		}
		
		function addEventLongTap() {
			var arrItems = document.querySelectorAll('.img-selected');

			[].forEach.call(arrItems, function(item) {
				item.addEventListener('longtap', function() {
					currentImgItem = this;
					mui('#img_action_list').popover('toggle');
				})
			});
		}

		function add_img() {
			if(document.querySelectorAll('.img-selected').length >= app.max_count_photos) {
				mui.toast('取证照片已至最大数量');
				return;
			}

			mui('#picture').popover('toggle');
		}

		function del_img() {
			if(currentImgItem) {
				currentImgItem.parentNode.removeChild(currentImgItem);
				currentImgItem = null;
			}

			mui('#img_action_list').popover('toggle');
		}

		function getImage() {
			var cmr = plus.camera.getCamera();
			cmr.captureImage(function(path) {
				//				console.log('get image ' + path);
				//				addImg(path);

				plus.gallery.save(path, function(event) {
					plus.io.resolveLocalFileSystemURL(path, function(entry) {
						addImg("file://" + entry.fullPath);
					}, function(e) {
						console.log('路径解析失败: ' + JSON.stringify(e));
					});
				}, function(e) {
					console.log('保存失败: ' + JSON.stringify(e));
				});
			}, function(e) {
				//			console.log(JSON.stringify(e));
			}, {
				filename: '_doc/gallery/',
				index: 1
			});

			mui('#picture').popover('toggle');
		}

		function addImg(strSrc) {
			// console.log(strSrc);

			plus.io.resolveLocalFileSystemURL(strSrc, function(entry) {
				//			console.log(entry);
				entry.getMetadata(function(metadata) {
					if(metadata.size > 1024 * 1024) // 1M
					{
						// comparess image
						var nPtPos = strSrc.lastIndexOf('.');
						var strDst = '';
						if(nPtPos > 0) {
							strDst = strSrc.substr(0, nPtPos) + '_s50' + strSrc.substr(nPtPos);
						} else {
							strDst = strSrc + '_s50';
						}
						//					console.log('dist ' + strDst);

						// compress image
						var wUI = plus.nativeUI.showWaiting('压缩中...');
						plus.zip.compressImage({
								src: strSrc,
								dst: strDst,
								overwrite: true,
								width: '100%',
								height: '100%',
								quality: 80
							},
							function(e) {
								wUI.close();

								// add image
								//							console.log('compress size: ' + e.size);

								//							console.log(e.target);
								var newImg = document.createElement('img');
								newImg.src = e.target;
								newImg.classList.add("img-selected");

								newImg.addEventListener('longtap', function() {
									currentImgItem = this;
									mui('#img_action_list').popover('toggle');
								})

								img_list.appendChild(newImg);
							},
							function(e) {
								wUI.close();
								mui.toast('压缩文件失败：' + e.message);
							})
					} else {
						var newImg = document.createElement('img');
						newImg.src = strSrc;
						newImg.classList.add("img-selected");

						newImg.addEventListener('longtap', function() {
							currentImgItem = this;
							mui('#img_action_list').popover('toggle');
						})

						img_list.appendChild(newImg);
					}
				}, function(err) {
					mui.toast('打开文件错误');
				})
			});
		}

		function galleryImgsMaximum() {
			var maxValue = app.max_count_photos - document.querySelectorAll('.img-selected').length;
			if(maxValue < 0)
				maxValue = 0;

			if(maxValue == 0) {
				alert('取证图片已选至最大数量');
				mui('#picture').popover('toggle');
				return;
			}

			// 从相册中选择图片
			plus.gallery.pick(function(e) {
				for(var i in e.files) {
					addImg(e.files[i]);
				}
			}, function(e) {
				//	outSet('取消选择图片');
			}, {
				filter: 'image',
				multiple: true,
				maximum: maxValue,
				system: false,
				onmaxed: function() {
					plus.nativeUI.alert('最多只能选择' + maxValue + '张图片');
				}
			}); // 最多选择3张图片

			mui('#picture').popover('toggle');
		}
		
		var upload;
//		保存
		function saveData() {
			if(!level1_id) {
				mui.toast('设施名称不能为空');
				return false;
			}
			if(need_point && !level2_id) {
				mui.toast('问题点不能为空');
				return false;
			}
// 			if(need_problem_device && !$('#selectDevice').attr('item_id'))
// 			{
// 				mui.toast('问题设备不能为空');
// 				return false;
// 			}
// 			if(!level3_id) {
// 				mui.toast('问题内容不能为空');
// 				return false;
// 			}

			if($("#selectDate").html() == "请选择...") {
				mui.toast('报告时间不能为空');
				return false;
			}
			if(inspectionType!=8502){
				if(!$("#select_problem_type").attr('item_id')) {
					mui.toast('问题类型不能为空');
					return false;
				}
				if(!$("#select_problem_item").attr('item_id')) {
					mui.toast('问题项目不能为空');
					return false;
				}
			}
			if(!$("#textarea").val()) {
				mui.toast('检查情况说明不能为空');
				return false;
			}
			if($(".img-selected").length == 0) {
				mui.toast('检查问题照片不能为空');
				return false;
			}

			var arrImgs = new Array();
			$(".img-selected").each(function(key, value) {
				arrImgs.push($(value).attr('src'))
			})

			upload = plus.nativeUI.showWaiting('上传中...');
			if(fg) {
				getImgToBase64(arrImgs)

				fg = false;
			}

			// app.setSetting('event_list',JSON.stringify(_event_list));
			//
			// var parentViewer = mui.currentWebview.opener();
			// mui.fire(parentViewer,'qpsw_refresh');
			//
			// app.ajaxBack();
			//
			// mui.toast('取证已保存，请至"信息流转/待上传"中查看，请手动提交服务器');
		}

		var count = 0;
		var file_data_arr = [];
		var fg = true;
		//上传
		function uploadImg() {
			// console.log("uploadImg")
			var xhr = new XMLHttpRequest();
			xhr.timeout = 120000;
			xhr.ontimeout = function(e) { 
				mui.toast('请求超时，请再网络状态良好的地方重试');
				upload.close()
			};

			var formData = new FormData();
			for(var i = 0; i < file_data_arr.length; i++) {
				formData.append('files', file_data_arr[i]);
			}

			formData.append("conservancyId", level1_id);
			
			if(inspectionType!=8502){
				formData.append("rectificationType", $('#select_problem_type').attr('item_id'));
				formData.append("subProblemId", $('#select_problem_item').attr('item_id'));
			}
			
			formData.append("targetId", level2_id);
			if($('#selectDevice').attr('item_name'))
			{
				formData.append("problemDeviceName", $('#selectDevice').attr('item_name'));
			}
			if(level3_id)
			formData.append("subTargetId", level3_id);
			formData.append("inspectionType", inspectionType);
			formData.append("rectificationReason", $("#textarea").val());
			formData.append("reportDate", $("#selectDate").html());
			// formData.append("problemId", $('#select_problem_type').attr('item_id'));
			

//			console.log(level1_id)
//			console.log(level2_id)
//			console.log(level3_id)
			
			console.log("--->开始上传了哈！")
			xhr.onreadystatechange = function(e) {
//				console.log(22222222)
				if(xhr.readyState == 4) {
					// console.log(xhr.responseText)
					var ret = JSON.parse(xhr.responseText);
					file_data_arr = [];
					count = 0;
					fg = true;
					if(xhr.status == 200) {
						
						if(ret.code == 200) {

							mui.toast('上传成功');
							var parentViewer = mui.currentWebview.opener();
							// console.log(ret.data)
							
							var arr = JSON.parse(app.getSetting("problem_report"+user_id) || "[]")
							var var_uuid = uuid ? uuid : new Date().format("yyyyMMddhhmmssS")
							for(var i = 0; i < arr.length; i++) {
								if(arr[i]["list_info"]["uuid"] == var_uuid) {
									arr.remove(arr[i])
								}
							}
							app.setSetting("problem_report"+user_id, JSON.stringify(arr));
							mui.fire(parentViewer, 'wga_refresh');
							//直接上传的刷上级
							app.setSetting('problem_upload_fire_data', JSON.stringify(ret.data))
							mui.fire(parentViewer, 'problem_refresh');
							mui.fire(parentViewer, 'problem_back');
							app.ajaxBack();
						} else {
							mui.toast(get_error_msg(ret,'上传失败，请重新保存'));
						}
					} else {
						mui.toast(get_error_msg(ret,'上传失败，请重新保存'));
					}
					upload.close()
					return;
				}
			}

			xhr.open('POST', app.url1('inspect/add/rectification'), true);
			xhr.send(formData);
		}

		//将图片转换为Base64
		function getImgToBase64(arr) {
//			console.log("getImgToBase64")
			var canvas = document.createElement('canvas'),
				ctx = canvas.getContext('2d'),
				img = new Image;
			img.crossOrigin = 'Anonymous';

			img.onload = function() {
				var originWidth = img.width;
		        var originHeight = img.height;
		        // 最大尺寸限制
		        var maxWidth = app.maxWidth(), maxHeight = app.maxWidth();
		        // 目标尺寸
		        var targetWidth = originWidth, targetHeight = originHeight;
		        // 图片尺寸超过1000x1000的限制
		        if (originWidth > maxWidth || originHeight > maxHeight) {
		            if (originWidth / originHeight > maxWidth / maxHeight) {
		                targetWidth = maxWidth;
		                targetHeight = Math.round(maxWidth * (originHeight / originWidth));
		            } else {
		                targetHeight = maxHeight;
		                targetWidth = Math.round(maxHeight * (originWidth / originHeight));
		            }
		        }
				
				// canvas对图片进行缩放
		        canvas.width = targetWidth;
		        canvas.height = targetHeight;
		    
		        // 清除画布
		        ctx.clearRect(0, 0, targetWidth, targetHeight);
		        // 图片压缩
		        ctx.drawImage(img, 0, 0, targetWidth, targetHeight);
			
				ctx.font = targetWidth / 20 + "px microsoft yahei";
				ctx.fillStyle = "rgba(255,128,0,1)";
				var txt = save_time ? save_time : current_time
				var pos_x = targetWidth - ctx.measureText(txt).width
				var pos_y = targetHeight - targetWidth / 20
			 
				ctx.fillText(txt, pos_x, pos_y);
				// console.log(targetWidth,targetHeight)
				var dataURL = canvas.toDataURL('image/jpeg');

				file_data_arr.push(dataURLtoFile(dataURL, 'img' + count + '.jpg'))
				//						console.log("====")
				count++;
				getImgToBase64(arr)

				canvas = null;
			};
			img.src = arr[count];
			if(file_data_arr.length == arr.length) {
				uploadImg()
			}
		}
		
		//将base64转换为文件
		function dataURLtoFile(dataurl, filename) {
			var arr = dataurl.split(','),
				mime = arr[0].match(/:(.*?);/)[1],

				bstr = atob(arr[1]),
				n = bstr.length,
				u8arr = new Uint8Array(n);
			//					console.log(mime)
			while(n--) {
				u8arr[n] = bstr.charCodeAt(n);
			}
			return new File([u8arr], filename, {
				type: mime
			});
		}
		
//		document.getElementById("scan_qr").addEventListener("tap",function(){
//			console.log("scan_qr")
//		})
	//二维码扫描
	function scaned(t, r, f){
		var facility_info_id = app.getUrlParam2('facility_info_id', r);
		var target_info_id = app.getUrlParam2('target_info_id', r);
		var device_serial_number = app.getUrlParam2('device_serial_number', r);
		
		if(facility_info_id && target_info_id){
			current_device_id = device_serial_number;
			//
			
			// console.log("scaned 执行了")
			var facility_name_data = [];
			var wDlg = plus.nativeUI.showWaiting("加载中...");
			app.ajax(app.url('query/facility_detail'), {
				facility_id: facility_info_id,
				inspectionType:inspectionType
			}, function(ret) {
				wDlg.close();
				console.log(JSON.stringify(ret))
				if(ret.code == 0 ) {
					var data = ret.data.items;
					check_item_obj = {}
					//					console.log(JSON.stringify(data))
 
					facility_name_data.push({
						value: data["id"],
						text: data["name"]
					})

					check_item_obj[data["id"]] = data["check_items"]

					namePicker.setData(facility_name_data);
				 
					var check_item = check_item_obj[data["id"]]
					level1_id = data["id"];
					level1_name = data["name"]
					level2_id = ""
					level2_name = "请选择.."
					
					level3_id = ""
					level3_name = "请选择.."
					
					select_problem_point.innerHTML = level2_name
					select_problem_content.innerHTML = level3_name
					
					select_facility.innerText = data["name"];
					$('#select_facility').attr('item_id', facility_info_id);
					var arr = []
					check_item_item_obj = {}
					for(var i = 0; i < check_item.length; i++) {
						arr.push({
							value: check_item[i]["id"],
							text: check_item[i]["name"]
						})
						check_item_item_obj[check_item[i]["id"]] = check_item[i]["children"]
						if(check_item[i]["id"]==target_info_id){
							select_problem_point.innerText = check_item[i]["name"]
							level2_id = check_item[i]["id"];
							level2_name = check_item[i]["name"]
							level3_id = ""
							level3_name = "请选择.."
							$('#select_problem_point').attr('item_id', check_item[i]["id"]);
		 
							select_problem_content.innerHTML = level3_name

							arr_item = []
							var check_item_item = check_item_item_obj[check_item[i]["id"]]
							
							var err_list_html = ""
							if(check_item_item){
							for(var i = 0; i < check_item_item.length; i++) {
								arr_item.push({
									value: check_item_item[i]["id"],
									text: check_item_item[i]["name"]
								})
							}
							}
							init_level2_arr_item = arr_item
							level3_add_data(arr_item)
						}
					}
					init_level2_arr = arr
					init_level2_check_item_item_obj = check_item_item_obj
					
					level2_add_data(arr, check_item_item_obj);
				} else {
					mui.toast('获取设施详情失败：' + ret.error);
				}
			});
		}else{
			mui.toast("二维码参数不正确")
		}
	}
	var is_richang_flag = false;
	function initCtrls() {
		var select_facility = document.getElementById('select_facility');
		var select_problem_point = document.getElementById('select_problem_point');
		var select_problem_content = document.getElementById('select_problem_content');
		var selectDate = document.getElementById('selectDate');
		var select_problem_type = document.getElementById('select_problem_type');
		var select_problem_item = document.getElementById('select_problem_item');
		// select facility
		select_facility.addEventListener('tap', function(event) {
			namePicker.show(function(items) {
				current_device_id = '';
				select_facility.innerText = items[0]["text"];
				//							$('#selectArea').attr('item_id', items[0]["value"]);
				level1_id = items[0]["value"];
				level1_name = items[0]["text"];
				$('#select_facility').attr('item_id', items[0]["value"]);
				// console.log($('#select_facility').attr('item_id'));
				
				level2_id = ""
				level2_name = "请选择.."
				
				level3_id = ""
				level3_name = "请选择.."
				
				select_problem_point.innerHTML = level2_name
				select_problem_content.innerHTML = level3_name
				
				//							console.log(check_item_obj[items[0]["value"]])
				var check_item = check_item_obj[items[0]["value"]]
				var arr = []
				check_item_item_obj = {}
				for(var i = 0; i < check_item.length; i++) {
					arr.push({
						value: check_item[i]["id"],
						text: check_item[i]["name"]
					})
					check_item_item_obj[check_item[i]["id"]] = check_item[i]["children"]
				}
				init_level2_arr = arr
				init_level2_check_item_item_obj = check_item_item_obj
				level2_add_data(arr, check_item_item_obj)
			});
		}, false);
						
		// select problem point
		select_problem_point.addEventListener('tap', function(event) {
			pointPicker.show(function(items) {
				select_problem_point.innerText = items[0]["text"]?items[0]["text"]:"请选择..";
				
				level2_id = items[0]["value"]?items[0]["value"]:"";
				level2_name = items[0]["text"]?items[0]["text"]:"请选择..";
				$('#select_problem_point').attr('item_id', level2_id);
				// console.log($('#select_problem_point').attr('item_id'))
				level3_id = ""
				level3_name = "请选择.."

				select_problem_content.innerHTML = level3_name

				arr_item = []
				var check_item_item = check_item_item_obj[items[0]["value"]]
				// console.log(check_item_item)
				var err_list_html = ""
				if(check_item_item){
				for(var i = 0; i < check_item_item.length; i++) {
					arr_item.push({
						value: check_item_item[i]["id"],
						text: check_item_item[i]["name"]
					})
				}
				}
				init_level2_arr_item = arr_item
				level3_add_data(arr_item)
				selectDevice.innerText = "请选择..";
				$('#selectDevice').attr('item_id', '');
				$('#selectDevice').attr('item_name', '');
				init_device_list();
				
			});
		}, false);
			
		// select problem content
		select_problem_content.addEventListener('tap', function(event) {
			problem_content_picker.show(function(items) {
				select_problem_content.innerText = items[0]["text"]?items[0]["text"]:"请选择..";
				level3_id = items[0]["value"]? items[0]["value"]:"";
				level3_name = items[0]["text"]?items[0]["text"]:"请选择..";
			})
		})
		
		// select device
		selectDevice.addEventListener('tap',function(event){
			devicePicker.show(function(items) {
				if(items[0]["text"])
				{
					$('#selectDevice').attr('item_name', items[0]["text"]);
					selectDevice.innerText = items[0]["text"];
				}
				else
				{
					$('#selectDevice').attr('item_name', '');
					selectDevice.innerText = "请选择...";
				}
					
				if(items[0]["value"])
					$('#selectDevice').attr('item_id', items[0]["value"]);
				else
					$('#selectDevice').attr('item_id', '');
			});
		})
		select_problem_type.addEventListener('tap',function(event){
			select_problem_type_picker.show(function(items) {
				// console.log(items[0]["child_json"])
				if(items[0]["text"])
				{
					$('#select_problem_type').attr('item_name', items[0]["text"]);
					select_problem_type.innerText = items[0]["text"];
// 					if(items[0]["text"]=="日常养护"){
// 						need_problem_device = true;
// // 						$('#device_li').show();
// // 						selectDevice.innerText = "请选择..";
// // 						$('#selectDevice').attr('item_id', '');
// 						init_device_list()
// 					}else if(items[0]["text"]=="闸容闸貌" || items[0]["text"]=="运行管理"){
// 						need_problem_device = false;
// 						// $('#device_li').hide();
// 					}
					
					if(items[0]["text"]=="日常养护" || items[0]["text"]=="闸容闸貌"){
						need_point = true;
					}else if(items[0]["text"]=="运行管理"){
						need_point = false;
					}
					init_device_list()
				}
				else
				{
					$('#select_problem_type').attr('item_name', '');
					select_problem_type.innerText = "请选择...";
				}
					
				if(items[0]["value"]){
					$('#select_problem_type').attr('item_id', items[0]["value"]);
				}
				else
					$('#select_problem_type').attr('item_id', '');
					
				if(items[0]["child_json"]){
					var child_data = JSON.parse(items[0]["child_json"])
					select_problem_item_picker.setData(child_data);
					init_problem_item_arr = child_data
				}else{
					select_problem_item_picker.setData([]);
				}
				select_problem_item.innerText = "请选择..";
				$('#select_problem_item').attr('item_id', '');
			});
		})
		select_problem_item.addEventListener('tap',function(event){
			select_problem_item_picker.show(function(items) {
				if(items[0]["text"])
				{
					$('#select_problem_item').attr('item_name', items[0]["text"]);
					select_problem_item.innerText = items[0]["text"];
				}
				else
				{
					$('#select_problem_item').attr('item_name', '');
					select_problem_item.innerText = "请选择..";
				}
					
				if(items[0]["value"])
					$('#select_problem_item').attr('item_id', items[0]["value"]);
				else
					$('#select_problem_item').attr('item_id', '');
			});
		})
		// select_problem_item
	}
	
	</script>
</html>