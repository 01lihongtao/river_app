<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<link href="../../asset/css/mui.min.css" rel="stylesheet" />
		<link href="../../asset/css/iconfont.css" rel="stylesheet" />
		<link href="../../asset/css/mui.picker.min.css" rel="stylesheet" />
		<link href="../../asset/css/mui.poppicker.css" rel="stylesheet" />
		<link href="../../asset/css/style.css" rel="stylesheet" />
		<style>
			#list-option .mui-table-view-cell button {
				position: relative;
				right: inherit;
				-webkit-transform: inherit;
				transform: inherit;
			}
			
			.mui-table-view span.mui-pull-right {
				color: #999;
			}
			
			.img-selected {
				width: 80px;
				height: 80px;
				margin-top: 10px;
			}
			
			.mui-content>.mui-table-view:first-child {
				margin-top: 0;
			}
			
			.mui-table-view-cell.mui-active {
				background: #FFFFFF;
			}
			
			.problem_btn {
				width: 100px;
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;
			}
			
			.problem_no {
				font-size: 16px;
			}
			
			#device_li {
				display: none;
			}
			
			.btn_check_item {
				max-width: calc(100vw - 180px);
				word-break:break-all;
				white-space: normal;
			}
			
			@media screen and (max-width: 321px) {
				.problem_btn {
					width: 80px;
					overflow: hidden;
					font-size: 14px;
					text-overflow: ellipsis;
					white-space: nowrap;
					padding: 6px 2px !important;
				}
				.problem_no {
					font-size: 14px;
				}
			}
		</style>
	</head>

	<body onload="app.route()">
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<span id="scan_qr"  onclick="clicked('../../barcode_scan.html',true,true)" class=" mui-btn mui-btn-link mui-pull-left   iconfont icon-im_erweimasaomiao" style="font-weight:bold;font-size:18px;padding: 0 10px;margin-left:20px;"></span>
		 
			<a class="mui-btn mui-btn-link mui-pull-right btn_cancel">取消</a>
			<a class="mui-btn mui-btn-link mui-pull-right btn_submit" onclick="saveData()">上传</a>
			<a class="mui-btn mui-btn-link mui-pull-right" id="save_btn">保存</a>
			<h1 class="mui-title">巡检登记</h1>
		</header>
		<div class="mui-content">
			<ul id="list-option" class="mui-table-view">
				<li class="mui-table-view-cell">
					设施名称
					<span style="color:red">*</span>
					<span id="selectName" style="max-width: 100%;" class="mui-pull-right mui-ellipsis">请选择...</span>
					<input type="text" id="facility_input_name" placeholder="输入设施名称" style="width: 88px;padding: 0;margin: 0;line-height: 23px;height: 25px;float: right;    margin-right: 10px;font-size: 12px;z-index: 999;" />
				</li>
				<li class="mui-table-view-cell">
					巡检日期
					<!--<span style="color:red">*</span>-->
					<span id="selectDate" data-options='{"type":"date"}' style="max-width: 100%;" class="mui-pull-right mui-ellipsis">请选择...</span>
				</li>
				<li class="mui-table-view-cell">
					巡检点
					<span style="color:red">*</span>
					<span id="selectPoint" style="max-width: 100%;" class="mui-pull-right mui-ellipsis">请选择...</span>
					<span class="mui-pull-right mui-ellipsis">
						<i class="iconfont icon-biaoqian" style="font-size: 24px;color: #333;margin-right: 10px;" onclick="show_require_detail()"></i>
					</span>
				</li>
				<li id="device_li" class="mui-table-view-cell mui-hidden">
					巡检设备
					<span style="color:red">*</span>
					<span id="selectDevice" style="max-width: 100%;" class="mui-pull-right mui-ellipsis">请选择...</span>
					<span class="mui-pull-right mui-ellipsis">
						<i class="iconfont icon-biaoqian" style="font-size: 24px;color: #333;margin-right: 10px;" onclick="show_require_detail()"></i>
					</span>
				</li>
				<li class="mui-table-view-cell">
					<div style="line-height: 30px;">
						巡检结果

						<a class="mui-btn mui-btn-primary yuny-small  " onclick="show_require_detail()">巡查要求</a>
					
						<span class="mui-pull-right  " >
							
							<input class="isAbnormal" name="isAbnormal"   value="0"       type="radio">
							
							<label>异常</label>
						</span>
						<span class="mui-pull-right   ">
							
							<input name="isAbnormal" class="isAbnormal"  value="1"   checked="checked" type="radio">
							<label>正常</label>
						</span> 
					
					</div>
					<br>
					<div id="err_list">
						<!-- <h5>
					<button style="width: 100px;color: #999;"  >止水</button>
					<span class="mui-pull-right as_button" >
						
						<input class="err_checked" name="radio1"   err_type="1"    err_name="止水"    type="radio">
						
						<label>异常</label>
					</span>
					<span class="mui-pull-right  as_button">
						
						<input name="radio1" class="err_checked"   err_type="0"   err_name="止水"  checked="checked" type="radio">
						<label>正常</label>
					</span> 
 				</h5> -->

					</div>
				</li>
				<li id="pb_upload" class="mui-table-view-cell problem_upload " style="display: none;">
					问题上报
					<button   id="problem_add" class="as_button_add  mui-pull-right">
						<i class="iconfont icon-add"></i>
					</button>
					<br><br>
					<div id="problem_list" style="clear: both;">
						<!-- <a href="problem_reporting.html" class="link_open mui-block problem_no">NO.2018-11-310 13:40:58</a>
						<a href="problem_reporting.html" class="link_open  problem_no">NO.2018-11-310 13:40:58</a>
						 -->
					</div>
					<!-- <div style="clear: both;">
						<button class="problem_btn" style="color: #999;">止水</button>
						<a href="problem_reporting.html" class="as_button_add link_open"><i class="iconfont icon-add"></i></a>
						<a href="problem_reporting.html" class="mui-pull-right link_open as_button problem_no">NO.2018-11-310 13:40:58</a>
						<a href="problem_reporting.html" class="mui-pull-right link_open as_button problem_no">NO.2018-11-310 13:40:58</a>
					</div>
					<div style="clear: both;">
						<button class="problem_btn" style="color: #999;">啊速度发速度发水</button>
						<a href="problem_reporting.html" class="as_button_add link_open"><i class="iconfont icon-add"></i></a>
						<a href="problem_reporting.html" class="mui-pull-right link_open as_button problem_no">NO.2018-11-310 13:40:58</a>
						<a href="problem_reporting.html" class="mui-pull-right link_open as_button problem_no">NO.2018-11-310 13:40:58</a>
					</div> -->
				</li>

				<li class="mui-table-view-cell" id="inspection_pic">
					巡检照片(长按删除)
					<p>
						<button onclick="add_img()" class="mui-btn mui-btn-primary mui-btn-outlined mui-pull-right">
                    <i class="iconfont icon-add"></i>
                </button>
					</p>
					<br>
					<div id="img_list">
						<!--
                <img src="images/evid1.png" class="img-selected">
                <img src="images/evid1.png" class="img-selected">
                <img src="images/evid1.png" class="img-selected">
                -->
					</div>
				</li>

				<li class="mui-table-view-cell">备注<br><br>
					<textarea id="textarea" rows="3" placeholder="请输入描述信息"></textarea>
				</li>
			</ul>

		</div>
		<div id="picture" class="mui-popover mui-popover-action mui-popover-bottom">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a onclick="getImage()">拍照</a>
				</li>
				<li class="mui-table-view-cell">
					<a onclick="galleryImgsMaximum()">选取现有的</a>
				</li>
			</ul>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a href="#picture"><b>取消</b></a>
				</li>
			</ul>
		</div>

		<div id="img_action_list" class="mui-popover mui-popover-action mui-popover-bottom">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a onclick="del_img()">删除</a>
				</li>
			</ul>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a href="#img_action_list"><b>取消</b></a>
				</li>
			</ul>
		</div>
	</body>
	<script src="../../asset/js/jquery-3.3.1.min.js"></script>
	<script src="../../asset/js/mui.min.js"></script>
	<script src="../../asset/js/mui.picker.min.js"></script>
	<script src="../../asset/js/mui.poppicker.js"></script>
	<script src="../../asset/js/app.js"></script>
	<script type="text/javascript" src="../../asset/js/common.js"></script>
	<script type="text/javascript" charset="utf-8">
		var user_data = app.getUserInfo();
		var user_id = user_data.id
		var uuid = app.getUrlParam('uuid');//uuid 本地保存的唯一编号
		var inspectionType = app.getUrlParam('inspectionType');//uuid 本地保存的唯一编号
	 
		var require_detail = ""
		var level1_id = "";				//层级一的 id 也就是设施 id
		var level2_id = "";				//层级二的 id 也就是问题点 id
		var level3_id = "";				//层级三的 id 也就是问题内容 id
		var level1_name = "";
		var level2_name = "";
		var level3_name = "";
		var gb_img = '';
		var init_level2_data_arr = [];
		var init_level2_data_check_item_item_obj = {};
		var save_time = ""
		var fg1 = true;
		var namePicker = new mui.PopPicker();
		var pointPicker = new mui.PopPicker();
		var devicePicker = new mui.PopPicker();
		var selectName = document.getElementById('selectName');
		var selectDate = document.getElementById('selectDate');;
		var selectPoint = document.getElementById('selectPoint');
		var selectDevice = document.getElementById('selectDevice');
		var current_device_id = '';
		var need_problem_device = false;
		var current_time = new Date().format("yyyy-MM-dd hh:mm:ss")
		var user_data = app.getUserInfo();
		var cp_id = user_data.company_id;
		
	 	var inspection_info_draft = [];
		var save_draft_flag = false;
		var is_draft = false;
		
		
		
		try {
			//草稿
			if(inspectionType==8502){
				inspection_info_draft = JSON.parse(app.getSetting("inspection_info_draft_8502_" + user_data.id) || "[]") 
			}else{
				inspection_info_draft = JSON.parse(app.getSetting("inspection_info_draft" + user_data.id) || "[]") 
			}
			
	 	 } catch(err) {
	 	 	
	 	 }
		
		function init_uuid_or_draft() {
			// console.log(JSON.stringify(inspection_info_draft));
			
			//唯一编号 或者草稿
			if(uuid || inspection_info_draft[0]) {
				var inspection_info_data
				if(uuid) {
					save_draft_flag = true;
					$(".btn_cancel").hide()
					$(".btn_submit").show()
					inspection_info_data = JSON.parse(app.getSetting("inspection_info"+user_id) || "[]");
				} else {
					is_draft = true;
					$(".btn_cancel").show()
					$(".btn_submit").hide()
					inspection_info_data = inspection_info_draft
					uuid = inspection_info_data[0]["list_info"]["uuid"]
				}
				
				// console.log("inspection_info_data.length" + inspection_info_data.length)
				
				for(var i = 0; i < inspection_info_data.length; i++) {
					if(uuid == inspection_info_data[i]["list_info"]["uuid"]) {
						
						$(".mui-content").html(inspection_info_data[i]["data"]["html"])
						
						selectName = document.getElementById('selectName');
						selectDate = document.getElementById('selectDate');
						selectPoint = document.getElementById('selectPoint');
						selectDevice = document.getElementById('selectDevice');
						
						$("#textarea").val(inspection_info_data[i]["post_json"]["remark"])
						level1_id = inspection_info_data[i]["data"]["level1_id"]
						level2_id = inspection_info_data[i]["data"]["level2_id"]
						level3_id = inspection_info_data[i]["data"]["level3_id"]
						// console.log('inspection_info_data[i]["data"]["level1_name"]' + inspection_info_data[i]["data"]["level1_name"])
						level1_name = inspection_info_data[i]["data"]["level1_name"]
						level2_name = inspection_info_data[i]["data"]["level2_name"]
						level3_name = inspection_info_data[i]["data"]["level3_name"]
						require_detail = inspection_info_data[i]["data"]["require_detail"]
						$('#selectName').attr('item_id', level1_id);
						$('#selectPoint').attr('item_id', level2_id);
						if(level2_name) $('#selectPoint').text(level2_name); else $('#selectPoint').text("请选择..."); 
						
						init_level2_data_arr = inspection_info_data[i]["data"]["init_level2_data_arr"]
						init_level2_data_check_item_item_obj = inspection_info_data[i]["data"]["init_level2_data_check_item_item_obj"]
						var err_checked_arr = inspection_info_data[i]["data"]["err_checked_arr"]
						current_device_id = inspection_info_data[i]["data"]["device_id"];
						save_time = inspection_info_data[i]["list_info"]["time"]
						inspectionType = inspectionType?inspectionType:inspection_info_data[i]["post_json"]["inspectionType"]
						//数据塞入选择器
						init_level2_data(init_level2_data_arr, init_level2_data_check_item_item_obj);
						if(err_checked_arr) {
							$(".err_checked").each(function() {
								for(var i = 0; i < err_checked_arr.length; i++) {
									if($(this).attr("err_type") == 1 && $(this).attr("item_id") == err_checked_arr[i]) {
										$(this).prop("checked", true)
									}
								}
	
							})
						}
						if(is_draft){
							app.get_time(function(ret){
								// console.log("get_time:=====>"+ret)
								current_time = selectDate.innerHTML =    ret
							}) 
						}else{
							current_time = selectDate.innerHTML = inspection_info_data[i]["post_json"]["date"]
						}
						
					}
				}
			} else {
				$(".btn_cancel").show()
				$(".btn_submit").hide()
				// selectDate.innerHTML = new Date().format("yyyy-MM-dd hh:mm:ss")
				app.get_time(function(ret){
					// console.log("get_time:=====>"+ret)
					current_time = selectDate.innerHTML =    ret
				})
				
			}
		}

		mui.init({
			gestureConfig: {
				longtap: true
			},
			beforeback: function() {
				
				if(save_draft_flag){
				 
				}else{
					if(inspectionType==8502){
						app.setSetting("inspection_info_draft_8502_" + user_data.id, "[]");
					}else{
						app.setSetting("inspection_info_draft" + user_data.id, "[]");
					}
					
					// console.log("beforeback")
				
					var data_obj = check_param(false)
					var arr = back_save_data(data_obj, [])
					// console.log("arr:" + JSON.stringify(arr))
					if(inspectionType==8502){
						app.setSetting("inspection_info_draft_8502_" + user_data.id, JSON.stringify(arr));
					}else{
						app.setSetting("inspection_info_draft" + user_data.id, JSON.stringify(arr));
					}
					
				}
			}
		});
		
		var current_problem;

		mui.ready(function() {
		$("#pb_upload").hide()
		})

		function back_save_data(data_obj, arr) {
			var err_checked_arr = []
			$(".err_checked").each(function() {

				if($(this).prop("checked") && $(this).attr("err_type") == 1) {

					err_checked_arr.push($(this).attr("item_id"))
				}
			})
			var var_uuid = uuid ? uuid : new Date().format("yyyyMMddhhmmssS")
			for(var i = 0; i < arr.length; i++) {
				if(arr[i]["list_info"]["uuid"] == var_uuid) {
					arr.remove(arr[i])
				}
			}
			var arr_imgs = new Array();
			$(".img-selected").each(function(key, value) {
				arr_imgs.push($(value).attr('src'))
			})
			// console.log(arr_imgs)
			arr.push({
				list_info: {
					id: level1_id,
					name: level1_name,
					uuid: var_uuid,
					time: data_obj.time_save,
					user_name: user_data.user_name
				},
				post_json: data_obj,
				data: {
					html: $(".mui-content").html(),
					level1_id: level1_id,
					level2_id: level2_id,
					level3_id: level3_id,
					device_id: $('#selectDevice').attr('item_id'),
					level1_name: level1_name,
					level2_name: level2_name,
					level3_name: level3_name,
					device_name: $('#selectDevice').attr('item_name'),
					require_detail: require_detail,
					init_level2_data_arr: init_level2_data_arr,
					init_level2_data_check_item_item_obj: init_level2_data_check_item_item_obj,
					err_checked_arr: err_checked_arr
				},
				arr_imgs: arr_imgs
			})
			return arr;
		}
		
		var timer;
		var check_item_obj;
		var check_item_item_obj;
		
		function init_facility_list() {
			clearTimeout(timer)
			timer = setTimeout(function() {
				var facility_name_data = [];
				var wDlg = plus.nativeUI.showWaiting("加载中...");
				
				var post_data = {
					uid:app.getUserId(),
					// company_id: cp_id,
					page_size: 30,
					page_no: 1,
					facility_name: $.trim($("#facility_input_name").val())
				}
				if(inspectionType){
					post_data.inspectionType = inspectionType?inspectionType:8501
				}
				// console.log(JSON.stringify(post_data))
				app.ajax(app.url('query/facility_list'), post_data, function(ret) {
					wDlg.close();
					// console.log('query/facility_list ->ret' + JSON.stringify(ret))
					if(ret.code == 0) {
						var data = ret.data.items;
						check_item_obj = {}
						//					console.log(JSON.stringify(data))
						for(var i = 0; i < data.length; i++) {
							facility_name_data.push({
								value: data[i]["id"],
								text: data[i]["name"]
							})

							check_item_obj[data[i]["id"]] = data[i]["check_items"]
						}
						namePicker.setData(facility_name_data);
					} else {
						mui.toast('获取设施列表失败：'+ ret.error);
					}
				});
			}, 600)
		}

// 		function err_checked_change() {
// 			var fg_err_checked = false;
// 
// 			$(".err_checked").each(function() {
// 				if($(this).prop("checked") && $(this).attr("err_type") == 1) {
// 					fg_err_checked = true;
// 				}
// 			})
// 
// 			if(fg_err_checked) {
// 				$(".problem_upload").show()
// 				//					$("#inspection_pic").hide()
// 				$(".err_checked").each(function() {
// 					if($(this).prop("checked") && $(this).attr("err_type") == 1) {
// 						$(".problem_warp_" + $(this).attr("item_id")).show()
// 					}
// 					if($(this).prop("checked") && $(this).attr("err_type") == 0) {
// 						$(".problem_warp_" + $(this).attr("item_id")).hide()
// 					}
// 				})
// 			} else {
// 				//					$("#inspection_pic").show()
// 				$(".problem_upload").hide()
// 			}
// 		}


		function init_level2_data(arr, acheck_item_item_obj) {
			check_item_item_obj = acheck_item_item_obj
			pointPicker.setData(arr);
			// init_device_list();
		}
		
		function init_device_list() {
			devicePicker.setData([]);
			$('selectDevice').attr('item_id','');
			$('selectDevice').attr('item_name','');
			$('selectDevice').text('请选择...');
			
			// console.log('init_device_list');
			
			var _facilityId = $('#selectName').attr('item_id');
			var _pointId = $('#selectPoint').attr('item_id');
			// console.log(_facilityId);
			// console.log(_pointId);
			if(_facilityId == '' || _pointId == '')
			{
				return;
			}
			
			var point_name = $('#selectPoint').text();
			
			// console.log(point_name);
			
			need_problem_device = false;
			if(point_name)
				need_problem_device = point_name.indexOf('闸门') >= 0 || point_name.indexOf('启闭机') >= 0 || point_name.indexOf('水泵') >= 0;

			if(need_problem_device)
			{
				$('#device_li').show();
			}
			else
			{
				$('#device_li').hide();
				return;
			}
			
			app.ajax(app.url1('inspection/getDeviceSerial'),{facilityId:_facilityId,targetId: _pointId},function(ret){
				if(ret.code == 200)
				{
					var arr = [];
					for(var i = 0; i < ret.data.length; ++i)
					{
						var item_name = ret.data[i]["deviceName"] ? ret.data[i]["deviceName"] : (ret.data[i]["gateName"] ? ret.data[i]["gateName"] : ret.data[i]["pumpName"]);
						arr.push({
							value: ret.data[i]["deviceSerialNumber"],
							text: item_name
						})
						
						if(current_device_id && current_device_id == ret.data[i]["deviceSerialNumber"])
						{
							$('#selectDevice').attr('item_id', current_device_id);
							$('#selectDevice').attr('item_name', item_name);
							$('#selectDevice').text(item_name);
						}
					}
					
					devicePicker.setData(arr);
				}
				else
				{
					mui.toast('获取设备列表失败：' + ret.error);
				}
			})
		}

// 		function init_problem_html(item_name, item_id) {
// 			var pb_html = ""
// 			pb_html += '<div class="pb_warp problem_warp_' + item_id + '" style="clear: both;display:none;">'
// 			pb_html += '<button class="problem_btn" style="color: #999;">' + item_name + '</button>'
// 			pb_html += '<a  class="as_button_add problem_reporting " item_id="' + item_id + '" item_name="' + item_name + '" ><i class="iconfont icon-add"></i></a>'
// 
// 			pb_html += '</div>'
// 			return pb_html;
// 		}
// 
		function show_require_detail() {
			if(require_detail == "") {
				mui.alert("请先选择检查点")
			} else {
				mui.alert(require_detail)
			}
		}
		mui.plusReady(function() {
			plus.screen.lockOrientation("portrait-primary");
		});
//		监听刷新
		window.addEventListener('problem_refresh', function(event) {
			var data = app.getSetting('problem_upload_fire_data');
			console.log("--->"+data);
			data = JSON.parse(data)
			var html = $("#problem_list").html()
			html += '<a  problem_no="'+data.rectificationSerial+'" problem_id="'+data.rectificationId+'" class=" mui-block   problem_no">'+data.rectificationSerial+'</a>'
			$("#problem_list").html(html)

			app.setSetting('problem_upload_fire_data', "")
		});

		function addEventLongTap() {
			var arrItems = document.querySelectorAll('.img-selected');

			[].forEach.call(arrItems, function(item) {
				item.addEventListener('longtap', function() {
					currentImgItem = this;
					mui('#img_action_list').popover('toggle');
				})
			});
		}

		function add_img() {
			if(document.querySelectorAll('.img-selected').length >= app.max_count_photos) {
				mui.toast('取证照片已至最大数量');
				return;
			}

			mui('#picture').popover('toggle');
		}

		function del_img() {
			if(currentImgItem) {
				currentImgItem.parentNode.removeChild(currentImgItem);
				currentImgItem = null;
			}

			mui('#img_action_list').popover('toggle');
		}

		function getImage() {
			var cmr = plus.camera.getCamera();
			cmr.captureImage(function(path) {
				//				console.log('get image ' + path);
				//				addImg(path);

				plus.gallery.save(path, function(event) {
					plus.io.resolveLocalFileSystemURL(path, function(entry) {
						addImg("file://" + entry.fullPath);
					}, function(e) {
						// console.log('路径解析失败: ' + JSON.stringify(e));
					});
				}, function(e) {
					// console.log('保存失败: ' + JSON.stringify(e));
				});
			}, function(e) {
				//			console.log(JSON.stringify(e));
			}, {
				filename: '_doc/gallery/',
				index: 1
			});

			mui('#picture').popover('toggle');
		}
		
//		添加图片
		function addImg(strSrc) {
			// console.log(strSrc);

			plus.io.resolveLocalFileSystemURL(strSrc, function(entry) {
				//			console.log(entry);
				entry.getMetadata(function(metadata) {
					if(metadata.size > 1024 * 1024) // 1M
					{
						// comparess image
						var nPtPos = strSrc.lastIndexOf('.');
						var strDst = '';
						if(nPtPos > 0) {
							strDst = strSrc.substr(0, nPtPos) + '_s50' + strSrc.substr(nPtPos);
						} else {
							strDst = strSrc + '_s50';
						}
						//					console.log('dist ' + strDst);

						// compress image
						var wUI = plus.nativeUI.showWaiting('压缩中...');
						plus.zip.compressImage({
								src: strSrc,
								dst: strDst,
								overwrite: true,
								width: '100%',
								height: '100%',
								quality: 80
							},
							function(e) {
								wUI.close();

								// add image
								//							console.log('compress size: ' + e.size);

								//							console.log(e.target);
								var newImg = document.createElement('img');
								newImg.src = e.target;
								newImg.classList.add("img-selected");

								newImg.addEventListener('longtap', function() {
									currentImgItem = this;
									mui('#img_action_list').popover('toggle');
								})

								img_list.appendChild(newImg);
							},
							function(e) {
								wUI.close();
								mui.toast('压缩文件失败：' + e.message);
							})
					} else {
						var newImg = document.createElement('img');
						newImg.src = strSrc;
						newImg.classList.add("img-selected");

						newImg.addEventListener('longtap', function() {
							currentImgItem = this;
							mui('#img_action_list').popover('toggle');
						})

						img_list.appendChild(newImg);
					}
				}, function(err) {
					mui.toast('打开文件错误');
				})
			});
		}

		function galleryImgsMaximum() {
			var maxValue = app.max_count_photos - document.querySelectorAll('.img-selected').length;
			if(maxValue < 0)
				maxValue = 0;

			if(maxValue == 0) {
				alert('取证图片已选至最大数量');
				mui('#picture').popover('toggle');
				return;
			}

			// 从相册中选择图片
			plus.gallery.pick(function(e) {
				for(var i in e.files) {
					addImg(e.files[i]);
				}
			}, function(e) {
				//	outSet('取消选择图片');
			}, {
				filter: 'image',
				multiple: true,
				maximum: maxValue,
				system: false,
				onmaxed: function() {
					plus.nativeUI.alert('最多只能选择' + maxValue + '张图片');
				}
			}); // 最多选择3张图片

			mui('#picture').popover('toggle');
		}
		
//		检查参数
		function check_param(flag) {
			if(flag) {
				if(!$("#selectName").attr('item_id')) {
					mui.toast('设施名称不能为空');
					return false;
				}
				if(!$("#selectPoint").attr('item_id')) {
					mui.toast('巡检点不能为空');
					return false;
				}
// 				if(need_problem_device && !$("#selectDevice").attr('item_id'))
// 				{
// 					mui.toast('巡检设备不能为空');
// 					return false;
// 				}
				if($(".img-selected").length == 0) {
					mui.toast('巡检照片不能为空');
					return false;
				}
// 				var vv_fg = true;
// 				$(".pb_warp:visible").each(function() {
// 					var fg1 = false;
// 					$(this).find(".problem_no").each(function() {
// 						if($(this).html() != "") {
// 							fg1 = true;
// 						}
// 					})
// 					console.log(fg1)
// 					if(!fg1) {
// 						vv_fg = false;
// 					}
// 				})
// 				if(!vv_fg) {
// 					mui.toast('问题上报 编号不能为空');
// 					return false;
// 				}
			}
			var result_arr = [];
			var data_obj = {}

			data_obj["facilityType"] = 8601;
			data_obj["facilityId"] = level1_id;
			data_obj["inspectionType"] = inspectionType?inspectionType:8501;
			data_obj["targetId"] = $("#selectPoint").attr('item_id');
			data_obj["inspectionTime"] = current_time;
			//				data_obj["check_point"] = $("#selectDevice").attr('item_id');
			// deviceSerial:  //巡检设备编号，有就传，没有就空着；（之前怎么得到的设备编号，保持不变）
			data_obj["time_save"] = selectDate.innerHTML;
			data_obj["date"] = selectDate.innerHTML;
			data_obj["isAbnormal"] = $(".isAbnormal:checked").val();
			data_obj["remark"] = $("#textarea").val();
			// console.log($("#pb_upload").is(':hidden'))
			var rectificationSerialArr = [];
				
			if($("#pb_upload").is(':hidden')){
				
			}else{
				$(".problem_no").each(function(v){
					rectificationSerialArr.push($(".problem_no").eq(v).html().trim())
				})
			}	
			data_obj["rectificationSerial"] = JSON.stringify(rectificationSerialArr);
			return data_obj;
		}
		
		var upload;
		var globle_post_data;
		//上传
		function saveData() {
			$("#loading").show();
			globle_post_data = check_param(true);
			// console.log(JSON.stringify(globle_post_data));
			
			if(!globle_post_data) {
				return false
			}
			var arrImgs = new Array();
			$(".img-selected").each(function(key, value) {
				arrImgs.push($(value).attr('src'))
			})
			// console.log(arrImgs)

			upload = plus.nativeUI.showWaiting('上传中...');
			if(fg) {
				getImgToBase64(arrImgs)

				fg = false;
			}
		}
		//保存
		$("#save_btn").click(function() {
			var data_obj = check_param(true)
			if(!data_obj) {
				return false
			}
			// console.log("data_obj:" + data_obj)
			var arr;
		
			//				app.setSetting("inspection_info"+user_id, JSON.stringify([]));
		
			if(app.getSetting("inspection_info"+user_id) == "") {
				arr = [];
			} else {
				arr = JSON.parse(app.getSetting("inspection_info"+user_id) || "[]")
			}
			var return_arr = back_save_data(data_obj, arr)
			//				return;
			app.setSetting("inspection_info"+user_id, JSON.stringify(return_arr));
			if(inspectionType==8502){
				app.setSetting("inspection_info_draft_8502_" + user_data.id, "[]");
			}else{
				app.setSetting("inspection_info_draft" + user_data.id, "[]");
			}
			
			
			save_draft_flag = true
			var parentViewer = mui.currentWebview.opener();
			mui.fire(parentViewer, 'wga_refresh');
			mui.toast('巡检登记已保存，请至"信息流转/巡检信息流转"中查看，请手动提交服务器');
			app.ajaxBack();
		})
		var count = 0;
		var file_data_arr = [];
		var fg = true;
		//图片上传
		function uploadImg() {
			// console.log("uploadImg")
			var xhr = new XMLHttpRequest();
			xhr.timeout = 120000;
			xhr.ontimeout = function(e) {
				mui.toast('请求超时，请再网络状态良好的地方重试');
				upload.close()
			};
			var formData = new FormData();

			for(var i = 0; i < file_data_arr.length; i++) {
				formData.append('files', file_data_arr[i]);
			}
			for(var item in globle_post_data) {
				if(item =="rectificationSerial"){
					var rectificationSerialArr = JSON.parse(globle_post_data["rectificationSerial"])
					if(rectificationSerialArr.length==0){
						formData.append(item, "");
					}else{
						for (var i = 0; i < rectificationSerialArr.length; i++) {
							
							formData.append(item, rectificationSerialArr[i]);
						}
					}
					
				}else{
					// console.log(globle_post_data[item])
					formData.append(item, globle_post_data[item]);
				}
				
			}
			
			// console.log(JSON.stringify(formData))

			xhr.onreadystatechange = function(e) {
				if(xhr.readyState == 4) {
					console.log(xhr.responseText)
					var ret = JSON.parse(xhr.responseText);
					file_data_arr = [];
					count = 0;
					fg = true;
					if(xhr.status == 200) {
						if(ret.code == 200) {
							mui.toast('上传成功');
							var parentViewer = mui.currentWebview.opener();
							console.log(ret.data)
							
							var arr = JSON.parse(app.getSetting("inspection_info"+user_id) || "[]")
							var var_uuid = uuid ? uuid : new Date().format("yyyyMMddhhmmssS")
							//清除
							for(var i = 0; i < arr.length; i++) {
								if(arr[i]["list_info"]["uuid"] == var_uuid) {
									arr.remove(arr[i])
								}

							}
							app.setSetting("inspection_info"+user_id, JSON.stringify(arr));
							save_draft_flag = true;
							mui.fire(parentViewer, 'wga_refresh');
							app.ajaxBack();

						} else {
							mui.toast(get_error_msg(ret,'上传失败，请重新保存'));
						}

					} else {
						mui.toast(get_error_msg(ret,'上传失败，请重新保存'));
					}
					upload.close()
					return;
				}
			}

			xhr.open('POST', app.url('save/check_register'), true);
			xhr.send(formData);
		}

		//将图片转换为Base64
		function getImgToBase64(arr) {
//			console.log("getImgToBase64")
			var canvas = document.createElement('canvas'),
				ctx = canvas.getContext('2d'),
				img = new Image;
			img.crossOrigin = 'Anonymous';

			img.onload = function() {
				var originWidth = img.width;
		        var originHeight = img.height;
		        // 最大尺寸限制
		        var maxWidth = app.maxWidth(), maxHeight = app.maxWidth();
		        // 目标尺寸
		        var targetWidth = originWidth, targetHeight = originHeight;
		        // 图片尺寸超过1000x1000的限制
		        if (originWidth > maxWidth || originHeight > maxHeight) {
		            if (originWidth / originHeight > maxWidth / maxHeight) {
		                targetWidth = maxWidth;
		                targetHeight = Math.round(maxWidth * (originHeight / originWidth));
		            } else {
		                targetHeight = maxHeight;
		                targetWidth = Math.round(maxHeight * (originWidth / originHeight));
		            }
		        }
				
				// canvas对图片进行缩放
		        canvas.width = targetWidth;
		        canvas.height = targetHeight;
		    
		        // 清除画布
		        ctx.clearRect(0, 0, targetWidth, targetHeight);
		        // 图片压缩
		        ctx.drawImage(img, 0, 0, targetWidth, targetHeight);
			
				ctx.font = targetWidth / 20 + "px microsoft yahei";
				ctx.fillStyle = "rgba(255,128,0,1)";
				var txt = save_time ? save_time : current_time
				var pos_x = targetWidth - ctx.measureText(txt).width
				var pos_y = targetHeight - targetWidth / 20
			 
				ctx.fillText(txt, pos_x, pos_y);
				// console.log(targetWidth,targetHeight)
				var dataURL = canvas.toDataURL('image/jpeg');

				file_data_arr.push(dataURLtoFile(dataURL, 'img' + count + '.jpg'))
				//						console.log("====")
				count++;
				getImgToBase64(arr)

				canvas = null;
			};
			img.src = arr[count];
			if(file_data_arr.length == arr.length) {
				uploadImg()
			}
		}
		
		//将base64转换为文件
		function dataURLtoFile(dataurl, filename) {
			var arr = dataurl.split(','),
				mime = arr[0].match(/:(.*?);/)[1],

				bstr = atob(arr[1]),
				n = bstr.length,
				u8arr = new Uint8Array(n);
			//					console.log(mime)
			while(n--) {
				u8arr[n] = bstr.charCodeAt(n);
			}
			return new File([u8arr], filename, {
				type: mime
			});
		}
		
		function generate_err_list(check_items)
		{
			if(check_items) {
				for(var i = 0; i < check_items.length; i++) {
					require_detail += check_items[i]["name"] + ":" + check_items[i]["detail"].replace('\n', '') + "\n"
				}
			}
			return false
			$("#err_list").html("")
			
			var err_list_html = "";
			
			if(check_items) {
				for(var i = 0; i < check_items.length; i++) {
					err_list_html += '<h5>'
					err_list_html += '<button style="color: #999;"  class="btn_check_item" >' + check_items[i]["name"] + '</button>'
					err_list_html += '<span class="mui-pull-right as_button" >'

					err_list_html += '	<input class="err_checked" name="radio' + i + '"   err_type="1"  item_id="' + check_items[i]["id"] + '"  err_name="' + check_items[i]["name"] + '"    type="radio">'

					err_list_html += '	<label>异常</label>'
					err_list_html += '</span>'
					err_list_html += '<span class="mui-pull-right  as_button">'

					err_list_html += '	<input name="radio' + i + '" class="err_checked"   err_type="0"  item_id="' + check_items[i]["id"] + '"   err_name="' + check_items[i]["name"] + '"  checked="checked" type="radio">'
					err_list_html += '	<label>正常</label>'
					err_list_html += '</span> '
					err_list_html += '</h5>'
					require_detail += check_items[i]["name"] + ":" + check_items[i]["detail"].replace('\n', '') + "\n"
				}
			}

			$("#err_list").html(err_list_html);
			
// 			var pb_html = "问题上报<br><br>"
// 			
// 			$(".err_checked").each(function() {
// 				if($(this).prop("checked")) {
// 					pb_html += init_problem_html($(this).attr("err_name"), $(this).attr("item_id"))
// 				}
// 			})
// 			$("#pb_upload").html(pb_html)
		}
		
		//二维码扫描
		function scaned(t, r, f){
			// console.log(r);
			var facility_info_id = app.getUrlParam2('facility_info_id', r);
			var target_info_id = app.getUrlParam2('target_info_id', r);
			var device_serial_number = app.getUrlParam2('device_serial_number', r);
			
			if(facility_info_id && target_info_id){
				// console.log(facility_info_id)
				// console.log(target_info_id)
				// console.log(device_serial_number)
				current_device_id = device_serial_number;
				
				//
				// console.log("scaned 执行了")
				var facility_name_data = [];
				var wDlg = plus.nativeUI.showWaiting("加载中...");
				app.ajax(app.url('query/facility_detail'), {
					facility_id: facility_info_id,
					inspectionType:inspectionType
				}, function(ret) {
					wDlg.close();
					// console.log(JSON.stringify(ret))
					if(ret.code == 0 ) {
						var data = ret.data.items;
						check_item_obj = {}
						//					console.log(JSON.stringify(data))
		 
						facility_name_data.push({
							value: data["id"],
							text: data["name"]
						})
						
						check_item_obj[data["id"]] = data["check_items"]
						
						selectName.innerText = data["name"]
						$('#selectName').attr('item_id', data["id"]);
						
						level1_id = data["id"] ? data["id"] : ""
						level1_name = data["name"] ?data["name"] : ""

						level2_id = ""
						selectPoint.innerText = "请选择..."
						$('#selectPoint').attr('item_id','');

// 						level3_id = ""
// 						$("#pb_upload").html("")
						namePicker.setData(facility_name_data);
						//							console.log(check_item_obj[items[0]["value"]])
						var check_item = check_item_obj[data["id"]]
						var arr = []
						check_item_item_obj = {}
						if(check_item) {
							for(var i = 0; i < check_item.length; i++) {
								arr.push({
									value: check_item[i]["id"],
									text: check_item[i]["name"]
								})
								check_item_item_obj[check_item[i]["id"]] = check_item[i]["children"]
								if(check_item[i]["id"]==target_info_id){
									//============
									selectPoint.innerText = check_item[i]["name"] ?check_item[i]["name"] : "请选择...";
									$('#selectPoint').attr('item_id', check_item[i]["id"] ? check_item[i]["id"] : "");
									level2_id = check_item[i]["id"] ? check_item[i]["id"] : ""
									level2_name = check_item[i]["name"]?check_item[i]["name"] : "请选择..."
									var check_item_item = check_item_item_obj[check_item[i]["id"]]
									
									generate_err_list(check_item_item);
									//============
								}
							}
						}
						init_level2_data_arr = arr;
						init_level2_data_check_item_item_obj = check_item_item_obj;
						init_level2_data(arr, check_item_item_obj);
					} else {
						mui.toast('获取设施详情失败：' + ret.error);
					}
				});
			}else{
				mui.toast("二维码参数不正确")
			}
		}
		
		$(function(){
			init_uuid_or_draft();
			
			initCtrl();
		})
		
		function initCtrl() {
			// console.log('initCtrl');
			
			selectName = document.getElementById('selectName');
			selectDate = document.getElementById('selectDate');
			selectPoint = document.getElementById('selectPoint');
			selectDevice = document.getElementById('selectDevice');
			
			// select name
			selectName.addEventListener('tap', function(event) {
				// console.log('selectName tap')
				namePicker.show(function(items) {
					if(items[0]["text"])
						selectName.innerText = items[0]["text"];
					else
						selectName.innerText = ""

					if(items[0]["value"])
						$('#selectName').attr('item_id', items[0]["value"]);
					else
						$('#selectName').attr('item_id','');

					level1_id = items[0]["value"] ? items[0]["value"] : ""
					level1_name = items[0]["text"] ? items[0]["text"] : ""

					level2_id = ""
					selectPoint.innerText = "请选择..."
					current_device_id = '';

// 					level3_id = ""
// 					
// 					$("#pb_upload").html("")

					//							console.log(check_item_obj[items[0]["value"]])
					var check_item = check_item_obj[items[0]["value"]]
					var arr = []
					check_item_item_obj = {}
					if(check_item) {
						for(var i = 0; i < check_item.length; i++) {
							arr.push({
								value: check_item[i]["id"],
								text: check_item[i]["name"]
							})
							check_item_item_obj[check_item[i]["id"]] = check_item[i]["children"]
						}
					}
					init_level2_data_arr = arr;
					init_level2_data_check_item_item_obj = check_item_item_obj;
					// console.log(JSON.stringify(arr))
					// console.log(JSON.stringify(check_item_item_obj))
					init_level2_data(arr, check_item_item_obj);
				});
			}, false);
			
			// select point
			selectPoint.addEventListener('tap', function(event) {
				pointPicker.show(function(items) {
					selectPoint.innerText = items[0]["text"] ? items[0]["text"] : "请选择...";
					$('#selectPoint').attr('item_id', items[0]["value"] ? items[0]["value"] : "");
					level2_id = items[0]["value"] ? items[0]["value"] : ""
					level2_name = items[0]["text"] ? items[0]["text"] : "请选择..."
					var check_item_item = check_item_item_obj[items[0]["value"]]
					current_device_id = '';
					
					generate_err_list(check_item_item);

					init_device_list();
				});
			}, false);
						
			// select device
			selectDevice.addEventListener('tap',function(event){
				devicePicker.show(function(items) {
					if(items[0]["text"])
					{
						$('#selectDevice').attr('item_name', items[0]["text"]);
						selectDevice.innerText = items[0]["text"];
					}
					else
					{
						$('#selectDevice').attr('item_name', '');
						selectDevice.innerText = "请选择...";
					}
						
					if(items[0]["value"])
						$('#selectDevice').attr('item_id', items[0]["value"]);
					else
						$('#selectDevice').attr('item_id', '');
				});
			})
			
			$(".btn_cancel").click(function() {
				mui.confirm('确定还原初始界面吗？', '巡检登记', ['否', '是'], function(e) {
					// console.log(e.index)
					if(e.index == 1) {
						if(inspectionType==8502){
							app.setSetting("inspection_info_draft_8502_" + user_data.id, "[]");
						}else{
							app.setSetting("inspection_info_draft" + user_data.id, "[]");
						}
						
						window.location.reload()
						//					mui.toast("还原成功")
					} else {

					}
				})
			})
			
			var timerInputName = 0;
			document.getElementById("facility_input_name").addEventListener('input', function() {
				if(timerInputName != 0)
				{
					clearTimeout(timerInputName);
					timerInputName = 0;
				}
				timerInputName = setTimeout(function(){
					init_facility_list();
				},1000);
			});

			document.getElementById("facility_input_name").addEventListener('tap', function() {
				// console.log('facility_input_name tap')
				$('#facility_input_name').focus();
			});
			//			selectDate.addEventListener('tap', function() {
			//				app.pickDate(this, true);
			//			}, false);

			var err_checkeds = document.getElementsByClassName('err_checked');
// 			mui(".mui-table-view-cell").on('change', ".err_checked", function(event) {
// 				err_checked_change()
// 			})
			mui(".mui-table-view-cell").on('change', ".isAbnormal", function(event) {
				// console.log($(".isAbnormal:checked").val())
				
				if($(".isAbnormal:checked").val()==1) {
					$("#pb_upload").hide()
					$(".isAbnormal[value='1']").attr("checked",true)
					$(".isAbnormal[value='0']").attr("checked",false)
				} else {
					$("#pb_upload").hide()
					$(".isAbnormal[value='0']").attr("checked",true)
					$(".isAbnormal[value='1']").attr("checked",false)
				}
				
				
			})
			$("#problem_add").click(function(){
	
				if(!level1_id) {
					mui.toast('设施名称不能为空');
					return false;
				}
				if(!level2_id) {
					mui.toast('巡检点不能为空');
					return false;
				}
				var open_url = "problem_reporting.html?level1_id=" + level1_id + "&level1_name=" + level1_name + "&level2_id=" + level2_id + "&level2_name=" + level2_name + "&inspectionType=" + inspectionType 
				
				// console.log(open_url);
				app.open(open_url);
			})
// 			mui('#pb_upload').on('tap', '.problem_reporting', function() {
// 				$(".problem_no").each(function() {
// 					if($(this).html() == "") {
// 						$(this).remove()
// 					}
// 				})
// 				current_problem = $('<a  class="mui-pull-right link_open as_button problem_no" style="clear:both"></a>')
// 				$(this).after(current_problem)
// 				current_problem.attr("item_id", $(this).attr("item_id"))
// 				current_problem.attr("item_name", $(this).attr("item_name"))
// 				current_problem.hide()
// 				level3_id = $(this).attr("item_id")
// 				level3_name = $(this).attr("item_name")
// 				var open_url = "problem_reporting.html?level1_id=" + level1_id + "&level1_name=" + level1_name + "&level2_id=" + level2_id + "&level2_name=" + level2_name + "&level3_id=" + level3_id + "&level3_name=" + level3_name;
// 				if(need_problem_device)
// 				{
// 					open_url += "&level4_id=" + $('#selectDevice').attr('item_id') + "&level4_name=" + $('#selectDevice').attr('item_name');
// 				}
// 				
// 				console.log(open_url);
// 				app.open(open_url);
// 			})
			
			
			addEventLongTap();
			
			init_facility_list();
		}
	</script>
</html>